function loadImageArray(e){this.onCompletion=function(){if(typeof this.onComplete=="function"){var e=this.pollStatus(),t={"imagesArray":this.imagesArray,"status":e};this.onComplete(t)}return},this.onLoad=function(e){return function(){e.objectsLoaded+=1,e.check(e.onSingle,this)}},this.onError=function(e){return function(){e.objectsError+=1,e.check(e.onErr,this)}},this.check=function(e,t){if(typeof e=="function"){var n=this.pollStatus();e({"obj":t,"status":n})}this.objectsLoaded+this.objectsError===this.objectsTotal&&this.onCompletion()},this.pollStatus=function(){return{"id":this.ID,"loaded":this.objectsLoaded,"error":this.objectsError,"total":this.objectsTotal}},this.ID=e.ID,this.onComplete=e.onComplete,this.onSingle=e.onSingle,this.onErr=e.onError,this.objectsLoaded=0,this.objectsError=0,this.objectsTotal=e.imageNames.length,this.imagesArray=[];for(var t=0;t<this.objectsTotal;t+=1)this.imagesArray[t]=new Image,this.imagesArray[t].onload=this.onLoad(this),this.imagesArray[t].onerror=this.onError(this),this.imagesArray[t].src=e.imageNames[t]}function loadMultipleImages(e){this.loadingManager=function(){var e=this;return function(t){var n=t;if(e.loaders[n.status.id]===undefined)throw new Error("in loaders, "+n.status.id+" is undefined");e.loaders[n.status.id].done=!0,e.loaders[n.status.id].images=e.loaders[n.status.id].imageArray.imagesArray,typeof e.onSingleArray=="function"&&e.onSingleArray(t);for(var r in e.loaders)if(e.loaders.hasOwnProperty(r)&&e.loaders[r].done!==!0)return;e.onComplete(e.loaders)}},this.errorManager=function(){var e=this;return function(t){typeof e.onError=="function"&&e.onError(t)}},this.singleManager=function(){var e=this;return function(t){typeof e.onSingle=="function"&&e.onSingle(t)}},this.multipleImages=e.multipleImages,this.onComplete=e.onComplete,this.onError=e.onError,this.onSingle=e.onSingle,this.onSingleArray=e.onSingleArray,this.loaders={};for(var t=0;t<this.multipleImages.length;t+=1){var n={};n.imageArray=new loadImageArray({"ID":this.multipleImages[t].ID,"imageNames":this.multipleImages[t].imageNames,"onComplete":this.loadingManager(),"onError":this.errorManager(),"onSingle":this.singleManager()}),n.done=!1,this.loaders[this.multipleImages[t].ID]=n}}function memoize(e,t){return t=t||5e3,function(){function i(t){return n[t]||(r-->0?n[t]=e(t):e(t))}var n={},r=t;return i}()}function fact_lookup(e){if(0<e<=100)return fact_table[e];var t=1;for(var n=2;n<=e;n++)t*=n;return t}function Hammer(e,t,n){function x(e){return e.touches?e.touches.length:1}function T(e){e=e||window.event;if(!S){var t=document,n=t.body;return[{"x":e.pageX||e.clientX+(t&&t.scrollLeft||n&&n.scrollLeft||0)-(t&&t.clientLeft||n&&t.clientLeft||0),"y":e.pageY||e.clientY+(t&&t.scrollTop||n&&n.scrollTop||0)-(t&&t.clientTop||n&&t.clientTop||0)}]}var r=[],i;for(var s=0,o=e.touches.length;s<o;s++)i=e.touches[s],r.push({"x":i.pageX,"y":i.pageY});return r}function N(e,t){return Math.atan2(t.y-e.y,t.x-e.x)*180/Math.PI}function C(e,t){var n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)}function k(e,t){if(e.length==2&&t.length==2){var n=C(e[0],e[1]),r=C(t[0],t[1]);return r/n}return 0}function L(e,t){if(e.length==2&&t.length==2){var n=N(e[1],e[0]),r=N(t[1],t[0]);return r-n}return 0}function A(e,t){t.touches=T(t.originalEvent),t.type=e,j(r["on"+e])&&r["on"+e].call(r,t)}function O(e){e=e||window.event,e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.returnValue=!1,e.cancelBubble=!0)}function M(){a={},l=!1,f=0,s=0,o=0,c=null}function D(n){switch(n.type){case"mousedown":case"touchstart":a.start=T(n),p=(new Date).getTime(),f=x(n),l=!0,b=n;var r=e.getBoundingClientRect(),i=e.clientTop||document.body.clientTop||0,d=e.clientLeft||document.body.clientLeft||0,v=window.pageYOffset||e.scrollTop||document.body.scrollTop,m=window.pageXOffset||e.scrollLeft||document.body.scrollLeft;g={"top":r.top+v-i,"left":r.left+m-d},y=!0,_.hold(n),t.prevent_default&&O(n);break;case"mousemove":case"touchmove":if(!y)return!1;w=n,a.move=T(n),_.transform(n)||_.drag(n);break;case"mouseup":case"mouseout":case"touchcancel":case"touchend":if(!y||c!="transform"&&n.touches&&n.touches.length>0)return!1;y=!1,E=n,_.swipe(n),c=="drag"?A("dragend",{"originalEvent":n,"direction":u,"distance":s,"angle":o}):c=="transform"?A("transformend",{"originalEvent":n,"position":a.center,"scale":k(a.start,a.move),"rotation":L(a.start,a.move),"distance":s,"distanceX":_distance_x,"distanceY":_distance_y}):_.tap(b),h=c,A("release",{"originalEvent":n,"gesture":c,"position":a.move||a.start}),M()}}function P(t){H(e,t.relatedTarget)||D(t)}function H(e,t){!t&&window.event&&window.event.toElement&&(t=window.event.toElement);if(e===t)return!0;if(t){var n=t.parentNode;while(n!==null){if(n===e)return!0;n=n.parentNode}}return!1}function B(e,t){var n={};if(!t)return e;for(var r in e)r in t?n[r]=t[r]:n[r]=e[r];return n}function j(e){return Object.prototype.toString.call(e)=="[object Function]"}function F(e,t,n){t=t.split(" ");for(var r=0,i=t.length;r<i;r++)e.addEventListener?e.addEventListener(t[r],n,!1):document.attachEvent&&e.attachEvent("on"+t[r],n)}function I(e,t,n){t=t.split(" ");for(var r=0,i=t.length;r<i;r++)e.removeEventListener?e.removeEventListener(t[r],n,!1):document.detachEvent&&e.detachEvent("on"+t[r],n)}var r=this,i={"prevent_default":!1,"css_hacks":!0,"swipe":!0,"swipe_time":200,"swipe_min_distance":20,"drag":!0,"drag_vertical":!0,"drag_horizontal":!0,"drag_min_distance":20,"transform":!0,"scale_treshold":.1,"rotation_treshold":15,"tap":!0,"tap_double":!0,"tap_max_interval":300,"tap_max_distance":10,"tap_double_distance":20,"hold":!0,"hold_timeout":500};t=B(i,t),function(){if(!t.css_hacks)return!1;var n=["webkit","moz","ms","o",""],r={"userSelect":"none","touchCallout":"none","userDrag":"none","tapHighlightColor":"rgba(0,0,0,0)"},i="";for(var s=0;s<n.length;s++)for(var o in r)i=o,n[s]&&(i=n[s]+i.substring(0,1).toUpperCase()+i.substring(1)),e.style[i]=r[o]}();var s=0,o=0,u=0,a={},f=0,l=!1,c=null,h=null,p=null,d={"x":0,"y":0},v=null,m=null,g={},y=!1,b,w,E,S="ontouchstart"in window;this.option=function(e,r){return r!=n&&(t[e]=r),t[e]},this.getDirectionFromAngle=function(e){var t={"down":e>=45&&e<135,"left":e>=135||e<=-135,"up":e<-45&&e>-135,"right":e>=-45&&e<=45},n,r;for(r in t)if(t[r]){n=r;break}return n},this.destroy=function(){S?I(e,"touchstart touchmove touchend touchcancel",D):(I(e,"mouseup mousedown mousemove",D),I(e,"mouseout",P))};var _={"hold":function(e){t.hold&&(c="hold",clearTimeout(m),m=setTimeout(function(){c=="hold"&&A("hold",{"originalEvent":e,"position":a.start})},t.hold_timeout))},"swipe":function(e){if(!a.move||c==="transform")return;var n=a.move[0].x-a.start[0].x,i=a.move[0].y-a.start[0].y;s=Math.sqrt(n*n+i*i);var f=(new Date).getTime(),l=f-p;if(t.swipe&&t.swipe_time>l&&s>t.swipe_min_distance){o=N(a.start[0],a.move[0]),u=r.getDirectionFromAngle(o),c="swipe";var h={"x":a.move[0].x-g.left,"y":a.move[0].y-g.top},d={"originalEvent":e,"position":h,"direction":u,"distance":s,"distanceX":n,"distanceY":i,"angle":o};A("swipe",d)}},"drag":function(e){var n=a.move[0].x-a.start[0].x,i=a.move[0].y-a.start[0].y;s=Math.sqrt(n*n+i*i);if(t.drag&&s>t.drag_min_distance||c=="drag"){o=N(a.start[0],a.move[0]),u=r.getDirectionFromAngle(o);var f=u=="up"||u=="down";if((f&&!t.drag_vertical||!f&&!t.drag_horizontal)&&s>t.drag_min_distance)return;c="drag";var h={"x":a.move[0].x-g.left,"y":a.move[0].y-g.top},p={"originalEvent":e,"position":h,"direction":u,"distance":s,"distanceX":n,"distanceY":i,"angle":o};l&&(A("dragstart",p),l=!1),A("drag",p),O(e)}},"transform":function(e){if(t.transform){if(x(e)!=2)return!1;var n=L(a.start,a.move),r=k(a.start,a.move);if(c!="drag"&&(c=="transform"||Math.abs(1-r)>t.scale_treshold||Math.abs(n)>t.rotation_treshold)){c="transform",a.center={"x":(a.move[0].x+a.move[1].x)/2-g.left,"y":(a.move[0].y+a.move[1].y)/2-g.top},l&&(a.startCenter=a.center);var i=a.center.x-a.startCenter.x,o=a.center.y-a.startCenter.y;s=Math.sqrt(i*i+o*o);var u={"originalEvent":e,"position":a.center,"scale":r,"rotation":n,"distance":s,"distanceX":i,"distanceY":o};return l&&(A("transformstart",u),l=!1),A("transform",u),O(e),!0}}return!1},"tap":function(e){var n=(new Date).getTime(),r=n-p;if(t.hold&&!(t.hold&&t.hold_timeout>r))return;var i=function(){if(d&&t.tap_double&&h=="tap"&&p-v<t.tap_max_interval){var e=Math.abs(d[0].x-a.start[0].x),n=Math.abs(d[0].y-a.start[0].y);return d&&a.start&&Math.max(e,n)<t.tap_double_distance}return!1}();if(i)c="double_tap",v=null,A("doubletap",{"originalEvent":e,"position":a.start}),O(e);else{var o=a.move?Math.abs(a.move[0].x-a.start[0].x):0,u=a.move?Math.abs(a.move[0].y-a.start[0].y):0;s=Math.max(o,u),s<t.tap_max_distance&&(c="tap",v=n,d=a.start,t.tap&&(A("tap",{"originalEvent":e,"position":a.start}),O(e)))}}};S?F(e,"touchstart touchmove touchend touchcancel",D):(F(e,"mouseup mousedown mousemove",D),F(e,"mouseout",P))}var K2={};K2.extend=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)},K2.clone=function(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,r=e.length;n<r;++n)t[n]=clone(e[n]);return t}if(e instanceof Object){t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},K2.mergeObject=function(e,t){var n={};if(!t)return e;for(var r in e)r in t?n[r]=t[r]:n[r]=e[r];return n},typeof console=="undefined"&&(console={"log":function(e){var t=!1;t&&alert(e)}}),K2.UIElement=function(e){arguments.length&&this.getready(e)},K2.UIElement.prototype.getready=function(e){this.ID=e.ID,this.isListening=e.isListening,typeof this.isListening=="undefined"&&(this.isListening=!0);if(typeof this.isListening!="boolean")throw"Property isListening for element "+this.ID+" is not boolean "+this.isListening;this.isVisible=e.isVisible,typeof this.isVisible=="undefined"&&(this.isVisible=!0);if(typeof this.isVisible!="boolean")throw"Property isVisible for element "+this.ID+" is not boolean "+this.isVisible;this.xOrigin=e.left,this.yOrigin=e.top,typeof e.ROILeft!="undefined"?this.ROILeft=e.ROILeft:this.ROILeft=this.xOrigin,typeof e.ROITop!="undefined"?this.ROITop=e.ROITop:this.ROITop=this.yOrigin,this.ROIWidth=e.ROIWidth,this.ROIHeight=e.ROIHeight,this.values={},this.transparency=e.transparency||1,this.objParms=e.objParms,typeof e!="undefined"&&(this.onValueSet=e.onValueSet)},K2.UIElement.prototype.isInROI=function(e,t){return!1},K2.UIElement.prototype.getValues=function(){var e=[],t;for(t in this.values)this.values.hasOwnProperty(t)&&e.push(t);return e},K2.UIElement.prototype.getXCoord=function(){return this.xOrigin},K2.UIElement.prototype.getYCoord=function(){return this.yOrigin},K2.UIElement.prototype.getWidth=function(){return this.width},K2.UIElement.prototype.getHeight=function(){return this.height},K2.UIElement.prototype.setHeight=function(e){this.height=e,typeof this.ROIHeight=="undefined"&&(this.ROIHeight=e)},K2.UIElement.prototype.setWidth=function(e){this.width=e,typeof this.ROIWidth=="undefined"&&(this.ROIWidth=e)},K2.UIElement.prototype.getValue=function(e){if(typeof this.values[e]=="undefined")throw new Error("Slot "+e+" not present or value undefined");return this.values[e]},K2.UIElement.prototype.setValue=function(e,t){if(typeof this.values[e]=="undefined")throw new Error("Slot "+e+" not present or value undefined");if(t===this.values[e])return;this.values[e]=t},K2.UIElement.prototype.setListening=function(e){if(typeof e!="boolean")throw"Property isListening for element "+this.ID+" is not boolean "+e;this.isListening=e},K2.UIElement.prototype.getListening=function(){return this.isListening},K2.UIElement.prototype.refresh=function(e){var t="call_"+e.type;if(typeof this[t]!="function")throw"Element "+this.ID+" "+t+" is not a function. Its type is "+typeof this[t];this[t](e)},K2.UIElement.prototype.call_CANVAS2D=function(e){var t="refresh_"+e.type;e.context.save(),e.context.globalAlpha=this.transparency;if(typeof this[t]!="function")throw"Element "+this.ID+" "+t+" is not a function. Its type is "+typeof this[t];this[t](e),e.context.restore()},K2.UIElement.prototype.getID=function(){return this.ID},K2.UIElement.prototype.setDrawClass=function(e){this.drawClass=e},K2.UIElement.prototype.setVisible=function(e){if(typeof e!="boolean")throw"Property isVisible for element "+this.ID+" is not boolean "+e;this.isVisible=e},K2.UIElement.prototype.getVisible=function(){return this.isVisible},K2.UIElement.prototype.setGraphicWrapper=function(e){this.wrapper=e},K2.UI=function(e,t){this.getEventPosition=function(e,t){var n=parseInt(document.defaultView.getComputedStyle(t,undefined).paddingLeft,10)||0,r=parseInt(document.defaultView.getComputedStyle(t,undefined).paddingTop,10)||0,i=parseInt(document.defaultView.getComputedStyle(t,undefined).borderLeftWidth,10)||0,s=parseInt(document.defaultView.getComputedStyle(t,undefined).borderTopWidth,10)||0,o=document.body.parentNode,u=o.offsetTop,a=o.offsetLeft,f=t,l=0,c=0,h,p;if(f.offsetParent!==undefined)do l+=f.offsetLeft,c+=f.offsetTop;while(f=f.offsetParent);l+=n+i+a,c+=r+s+u,h=e.pageX-l,p=e.pageY-c;var d=t.offsetWidth,v=t.offsetHeight,m=t.getAttribute("width"),g=t.getAttribute("height"),y=m/d,b=g/v;return h*=y,p*=b,{"x":h,"y":p}},this.getPosition=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;while(e);return{"x":t,"y":n}},this.onMouseEvent=function(){var e=this;return function(t){var n=t,r=t.type,i=e.getEventPosition(n,e.domElement);r==="mousedown"?e.mouseUp=!1:r==="mouseup"&&(e.mouseUp=!0),r==="mousemove"&&e.mouseUp===!1&&e.elementsNotifyEvent(i.x,i.y,r),e.elementsNotifyEvent(i.x,i.y,r)}},this.onHammerEvent=function(){var e=this;return function(t){var n=t.originalEvent,r=t.type,i=e.getEventPosition(n,e.domElement,t);e.elementsNotifyEvent(i.x,i.y,r)}},this.elementsNotifyEvent=function(e,t,n){for(var r=this.zMax;r>=this.zMin;r-=1)if(typeof this.zArray[r]!="undefined")for(var i=this.zArray[r].length-1;i>=0;i-=1)if(this.zArray[r][i].getListening()&&typeof this.zArray[r][i][n]=="function"){var s=this.zArray[r][i][n](e,t);if(typeof s!="undefined"){if(s instanceof Array)for(var o=0;o<s.length;o+=1)this.setValue({"elementID":this.zArray[r][i].ID,"slot":s[o].slot,"value":s[o].value});else this.setValue({"elementID":this.zArray[r][i].ID,"slot":s.slot,"value":s.value});if(this.breakOnFirstEvent===!0)return}}};var n=e.eventTarget||e.target,r=e.renderTarget||e.target;this.domElement=n;var i=function(){function t(t){var n=document.createElement(e[t]||"div");t="on"+t;var r=t in n;return r||(n.setAttribute(t,"return;"),r=typeof n[t]=="function"),n=null,r}var e={"select":"input","change":"input","submit":"form","reset":"form","error":"img","load":"img","abort":"img"};return t}();if(typeof Hammer=="undefined")throw"Hammer.js needed!";this.hammer=new Hammer(this.domElement,{"drag_min_distance":2}),this.hammer.ondragstart=this.onHammerEvent(),this.hammer.ondrag=this.onHammerEvent(),this.hammer.ondragend=this.onHammerEvent(),this.hammer.onswipe=this.onHammerEvent(),this.hammer.ontap=this.onHammerEvent(),this.hammer.ondoubletap=this.onHammerEvent(),this.hammer.onhold=this.onHammerEvent(),this.hammer.ontransformstart=this.onHammerEvent(),this.hammer.ontransform=this.onHammerEvent(),this.hammer.ontransformend=this.onHammerEvent(),this.hammer.onrelease=this.onHammerEvent(),i("touchstart")?(this.domElement.addEventListener("touchstart",this.onMouseEvent(),!0),console.log("touchstart supported")):(this.domElement.addEventListener("mousedown",this.onMouseEvent(),!0),console.log("no touchstart, supporting mousedown")),i("touchend")?(this.domElement.addEventListener("touchend",this.onMouseEvent(),!0),console.log("touchend supported")):(this.domElement.addEventListener("mouseup",this.onMouseEvent(),!0),console.log("no touchend, supporting mouseup")),this.domElement.addEventListener("mousemove",this.onMouseEvent(),!0),this.domElement.addEventListener("mouseover",this.onMouseEvent(),!0),this.domElement.addEventListener("mouseout",this.onMouseEvent(),!0),this.mouseUp=!0;var s;this.elements={},this.connections={},this.zArray=[],this.engine=K2.ENGINE.engineFactory(e.type,{"target":r}),typeof t!="undefined"&&(this.breakOnFirstEvent=t.breakOnFirstEvent||!1),this.addElement=function(e,t){var n,r;if(typeof this.elements[e.ID]!="undefined")throw new Error("Conflicting / Duplicated ID in UI: "+e.ID+" (IDs are identifiers and should be unique)");var i=0;typeof t!="undefined"&&typeof t.zIndex!="undefined"&&(i=t.zIndex);if(i<0||typeof i!="number")throw new Error("zIndex "+i+" invalid");var s={"element":e,"zIndex":i};this.elements[e.ID]=s,r=e.getValues(),typeof this.zArray[i]=="undefined"&&(this.zArray[i]=[]),this.zArray[i].push(this.elements[e.ID].element);if(typeof this.zMin=="undefined"||this.zMin>i)this.zMin=i;if(typeof this.zMax=="undefined"||this.zMax<i)this.zMax=i},this.removeElement=function(e){if(typeof this.elements[e]!="undefined"){var t=this.elements[e].zIndex,n=this.zArray[t];for(var r=0;r<n.length;r+=1)if(n[r].ID===e){n.splice(r,1);break}delete this.elements[e]}},this.isElement=function(e){return typeof this.elements[e]!="undefined"?!0:!1},this.setZIndex=function(e,t){if(typeof this.elements[e]=="undefined")throw"Could not find element ID: "+e;var n=this.elements[e].zIndex;if(n!==t){typeof this.zArray[t]=="undefined"&&(this.zArray[t]=[]);if(typeof this.zMin=="undefined"||this.zMin>t)this.zMin=t;if(typeof this.zMax=="undefined"||this.zMax<t)this.zMax=t;var r=this.zArray[n],i=this.zArray[t];for(var s=0;s<r.length;s+=1)if(r[s].ID===e){r.splice(s,1);break}i.push(this.elements[e].element),this.elements[e].zIndex=t}},this.getZIndex=function(e){if(typeof this.elements[e]!="undefined")return this.elements[e].zIndex;throw"Could not find element ID: "+e},this.setProp=function(e,t,n){if(typeof this.elements[e]=="undefined")throw"Could not find ID: "+e+" property: "+t;this.elements[e].element[t]=n},this.getProp=function(e,t){if(typeof this.elements[e]!="undefined")return this.elements[e].element[t];throw"Could not find ID: "+e+" property: "+t},this.getElement=function(e){return this.elements[e].element},this.connectSlots=function(e,t,n,r,i){if(typeof this.elements[e]=="undefined"||typeof this.elements[n]=="undefined")throw new Error("Element "+e+" or "+n+" not present.");if(typeof this.elements[e].element.values[t]=="undefined"||typeof this.elements[n].element.values[r]=="undefined")throw new Error("Slot "+t+" or "+r+" not present.");var s={"recvElement":n,"recvSlot":r};typeof i!="undefined"&&(typeof i.callback=="function"&&(s.callback=i.callback),s.cascade=!0,typeof i.cascade!="undefined"&&(s.cascade=i.cascade)),typeof this.connections[e]=="undefined"&&(this.connections[e]={}),typeof this.connections[e][t]=="undefined"&&(this.connections[e][t]=[]),this.connections[e][t].push(s)},this.resetSlots=function(){this.connections={}},this.unconnectSlots=function(e,t,n,r){},this.resetSenderSlot=function(e){},this.setValue=function(e){var t=[],n,r,i,s,o=1e3,u,a,f,l,c,h;if(typeof e.elementID=="undefined")throw"ID is undefined";u=e.elementID;if(typeof e.value=="undefined")throw"value is undefined";a=e.value,typeof e.fireCallback=="undefined"?l=!0:l=e.fireCallback,c=e.history;if(typeof this.elements[u]=="undefined")throw new Error("Element "+u+" not present.");if(typeof e.slot=="undefined"){f=this.elements[u].element.defaultSlot;if(typeof f===undefined)throw"Default slot is undefined!"}else f=e.slot;if(typeof c!="undefined"){t=c;for(var p=0;p<t.length;p+=1){if(t.length>o)throw new Error("Recursion exceeded");if(t[p].element===u&&t[p].slot===f)return}}this.elements[u].element.setValue(f,a),typeof this.elements[u].element.onValueSet=="function"&&l!==!1&&this.elements[u].element.onValueSet(f,this.elements[u].element.values[f],u),t.push({"element":u,"slot":f});if(typeof this.connections[u]!="undefined"&&typeof this.connections[u][f]!="undefined")for(s in this.connections[u][f])if(this.connections[u][f].hasOwnProperty(s)){n=this.connections[u][f][s],r=n.recvElement,i=n.recvSlot;if(typeof n.callback=="function"){var d={"sender":u,"sendSlot":f,"recv":r,"recvSlot":i,"ui":this};h=n.callback(a,d)}var v;n.cascade===!1?v=!1:v=!0,this.setValue({"elementID":r,"slot":i,"value":h,"history":t,"fireCallback":v})}},this.hideElement=function(e){var t;if(typeof this.elements[e]=="undefined")throw new Error("Element "+e+" not present.");t=this.elements[e].element.getVisible(),t===!0&&(this.elements[e].element.setVisible(!1),this.elements[e].element.setListening(!1))},this.unhideElement=function(e){var t;if(typeof this.elements[e]=="undefined")throw new Error("Element "+e+" not present.");t=this.elements[e].element.getVisible(),t===!1&&(this.elements[e].element.setVisible(!0),this.elements[e].element.setListening(!0))},this.setHidden=function(e,t){this.setVisible(e,!t)},this.setVisible=function(e,t){var n;if(typeof this.elements[e]=="undefined")throw new Error("Element "+e+" not present.");n=this.elements[e].element.getVisible(),n!==t&&(this.elements[e].element.setVisible(t),this.elements[e].element.setListening(t))},this.setListening=function(e,t){var n;if(typeof this.elements[e]=="undefined")throw new Error("Element "+e+" not present.");n=this.elements[e].element.getListening(),n!==t&&this.elements[e].element.setListening(t)},this.refreshZ=function(e){for(var t=e,n=this.zArray.length;t<n;t+=1)if(typeof this.zArray[t]=="object")for(var r=0,i=this.zArray[t].length;r<i;r+=1)this.zArray[t][r].getVisible()===!0&&this.zArray[t][r].refresh(this.engine)},this.refresh=function(e){e!==!1&&this.reset(),typeof this.zMin!="undefined"&&this.refreshZ(this.zMin)},this.reset=function(){this.engine.reset()}},K2.Area=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Area,K2.UIElement),K2.Area.prototype.getready=function(e){var t,n;K2.Area.superclass.getready.call(this,e),this.values={"width":0,"height":0,"selected":[],"xOffset":0,"yOffset":0,"doubletap":[],"held":[]},this.defaultSlot="height",this.color=e.color||"black",this.borderColor=e.borderColor||"green",this.proximity=Math.floor(e.proximity)||10,this.thickness=Math.floor(e.thickness)||this.proximity,e.thickness===0&&(this.thickness=0),this.borders=e.borders||{"top":!0,"bottom":!0,"right":!0,"left":!0},this.dragBorders=e.dragBorders||{"top":!0,"bottom":!0,"right":!0,"left":!0},this.move=e.move||"all",this.xMonotone=e.xMonotone||!1,this.yMonotone=e.yMonotone||!1;var r=e.height||0,i=e.width||0;this.values.width=i,this.values.height=r;var s=e.left||0,o=e.top||0;this.values.xOffset=s,this.values.yOffset=o},K2.Area.prototype.isInArea=function(e,t){var n=!1,r=!1;return this.values.width>0?e>this.values.xOffset&&e<this.values.xOffset+this.values.width&&(n=!0):e<this.values.xOffset&&e>this.values.xOffset+this.values.width&&(n=!0),this.values.height>0?t>this.values.yOffset&&t<this.values.height+this.values.yOffset&&(r=!0):t<this.values.yOffset&&t>this.values.height+this.values.yOffset&&(r=!0),n&&r?!0:!1},K2.Area.prototype.tap=K2.Area.prototype.dragstart=function(e,t){var n=this.values.xOffset-this.proximity,r=this.values.xOffset+this.proximity,i=this.values.xOffset+this.values.width-this.proximity,s=this.values.xOffset+this.values.width+this.proximity,o=this.values.height+this.values.yOffset+this.proximity,u=this.values.height+this.values.yOffset-this.proximity,a=this.values.yOffset+this.proximity,f=this.values.yOffset-this.proximity;e>n&&e<r&&this.dragBorders.left===!0&&(this.leftSide=!0,console.log("Left side click detected")),e>i&&e<s&&this.dragBorders.right===!0&&(this.rightSide=!0,console.log("Right side click detected")),t>u&&t<o&&this.dragBorders.bottom===!0&&(this.bottomSide=!0,console.log("Bottom side click detected")),t>f&&t<a&&this.dragBorders.top===!0&&(this.topSide=!0,console.log("Top side click detected")),this.isInArea(e,t)?(console.log("clicked inside!"),this.inside=!0,this.startPoint=[e,t]):this.inside=!1},K2.Area.prototype.drag=function(e,t){var n=[],r,i;if(this.leftSide&&this.borders.left){r=this.values.width-(e-this.values.xOffset);var s=e;this.xMonotone&&r<0&&(r=0,s=this.values.xOffset),n.push({"slot":"width","value":r}),n.push({"slot":"xOffset","value":s})}this.rightSide&&this.borders.right&&!this.leftSide&&(r=e-this.values.xOffset,this.xMonotone&&r<0&&(r=0),n.push({"slot":"width","value":r})),this.bottomSide&&this.borders.bottom&&(i=this.values.height+(t-(this.values.yOffset+this.values.height)),this.yMonotone&&i<0&&(i=0),n.push({"slot":"height","value":i}));if(this.topSide&&this.borders.top&&!this.bottomSide){i=this.values.height+(this.values.yOffset-t);var o=t;this.yMonotone&&i<0&&(i=0,o=this.values.yOffset),n.push({"slot":"yOffset","value":o}),n.push({"slot":"height","value":i})}if(n.length>0)return n;if(this.inside&&this.move!=="none"){var u=e-this.startPoint[0],a=t-this.startPoint[1];this.startPoint=[e,t];if(this.move==="all")return[{"slot":"xOffset","value":this.values.xOffset+u},{"slot":"yOffset","value":this.values.yOffset+a}];if(this.move==="x")return{"slot":"xOffset","value":this.values.xOffset+u};if(this.move==="y")return{"slot":"yOffset","value":this.values.yOffset+a}}},K2.Area.prototype.release=K2.Area.prototype.dragend=K2.Area.prototype.mouseup=function(e,t){var n;return this.leftSide=this.rightSide=this.bottomSide=this.topSide=!1,this.inside&&this.isInArea(e,t)&&(n={"slot":"selected","value":[e,t]}),this.inside=!1,n},K2.Area.prototype.hold=function(e,t){if(this.isInArea(e,t)){var n={"slot":"held","value":[e,t]};return n}},K2.Area.prototype.doubletap=function(e,t){if(this.isInArea(e,t))return{"slot":"doubletap","value":[e,t]}},K2.Area.prototype.setValue=function(e,t){K2.Area.superclass.setValue.call(this,e,t)},K2.Area.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){e.context.fillStyle=this.color,e.context.strokeStyle=this.borderColor,e.context.lineWidth=this.thickness;var t=Math.floor(this.thickness/2);e.context.fillRect(this.xOrigin+this.values.xOffset+t,this.values.yOffset+t,this.values.width-t*2,this.values.height-t*2),this.thickness>0&&e.context.strokeRect(this.xOrigin+this.values.xOffset,this.values.yOffset,this.values.width,this.values.height)}},K2.Area.prototype.getXCoord=function(){return this.values.xOrigin},K2.Area.prototype.getYCoord=function(){return this.values.yOrigin},K2.Area.prototype.getWidth=function(){return this.values.width},K2.Area.prototype.getHeight=function(){return this.values.height},K2.Area.prototype.setHeight=function(e){this.values.height=e,typeof this.ROIHeight=="undefined"&&(this.ROIHeight=e)},K2.Area.prototype.setWidth=function(e){this.values.width=e,typeof this.ROIWidth=="undefined"&&(this.ROIWidth=e)},K2.Curve=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Curve,K2.UIElement),K2.Curve.prototype.getready=function(e){K2.Curve.superclass.getready.call(this,e),this.values={"points":[],"selected":[],"held":[],"doubletap_c":[],"doubletap_h":[]},this.defaultSlot="points",this.setWidth(e.width),this.setHeight(e.height),this.curveType=e.curveType||"bezier",this.thickness=e.thickness||2,this.curveColor=e.curveColor||"black",this.helperColor=e.helperColor||"#CCCCCC",this.handleColor=e.handleColor||"red",this.curveLabels=typeof e.curveLabels=="boolean"?e.curveLabels:!1,this.terminalPointStyle=e.terminalPointStyle||"rect",this.paintTerminalPoints=e.paintTerminalPoints||"all",this.midPointStyle=e.midPointStyle||"circle",this.terminalPointSize=e.terminalPointSize||16,this.midPointSize=e.midPointSize||8,this.terminalPointColor=e.terminalPointColor||this.handleColor,this.midPointColor=e.midPointColor||this.handleColor,this.terminalPointFill=e.terminalPointFill||null,this.midPointFill=e.midPointFill||null,this.xMonotone=e.xMonotone||!1,this.handleSize=e.handleSize||this.terminalPointSize>this.midPointSize?this.terminalPointSize:this.midPointSize,this.handleClicked=null,this.supportPoints=[],this.selectStart=!1,this.whereHappened=[];switch(e.curveType){case"bezier":if(e.points.length%2!==0||e.points.length<4)throw"Incorrect number of points "+e.points.length;break;case"halfcosine":case"smooth":case"linear":if(e.points.length!==4)throw"Incorrect number of points "+e.points.length;break;default:throw"Unknown curve type "+e.curveType}var t=[];for(var n=0;n<e.points.length;n+=2)t.push([e.points[n],e.points[n+1]]);this.values.points=t},K2.Curve.prototype.isInCurve=function(e,t){for(i=0;i<this.supportPoints.length;i+=1)if(e>this.supportPoints[i][0]-this.thickness&&e<this.supportPoints[i][0]+this.thickness&&t>this.supportPoints[i][1]-this.thickness&&t<this.supportPoints[i][1]+this.thickness)return!0;return!1},K2.Curve.prototype.isInHandle=function(e,t){var n=this.values.points;for(var r=0;r<n.length;r+=1)if(e>n[r][0]-this.handleSize&&e<n[r][0]+this.handleSize&&t>n[r][1]-this.handleSize&&t<n[r][1]+this.handleSize)return r;return null},K2.Curve.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Curve.prototype.tap=K2.Curve.prototype.dragstart=K2.Curve.prototype.mousedown=function(e,t){var n=this.values.points;if(this.isInROI(e,t)){var r;if((r=this.isInHandle(e,t))!==null){this.handleClicked=r;if(r===0||r===n.length-1)return}if(this.isInCurve(e,t)){this.selectStart=!0;return}}},K2.Curve.prototype.xMonotoneFunc=function(e){e[0][0]>e[e.length-1][0]&&(e[0][0]>this.values.points[0][0]?e[0][0]=e[e.length-1][0]:e[e.length-1][0]=e[0][0])},K2.Curve.prototype.drag=function(e,t){var n={},r;return this.handleClicked!==null?(r=K2.GenericUtils.clone(this.values.points),this.isInROI(e,t)?(this.triggered=!1,r[this.handleClicked][0]=e,r[this.handleClicked][1]=t):(r[this.handleClicked][0]=e,r[this.handleClicked][1]=t,e>this.ROILeft+this.ROIWidth&&(r[this.handleClicked][0]=this.ROILeft+this.ROIWidth),e<this.ROILeft&&(r[this.handleClicked][0]=this.ROILeft),t>this.ROITop+this.ROIHeight&&(r[this.handleClicked][1]=this.ROITop+this.ROIHeight),t<this.ROITop&&(r[this.handleClicked][1]=this.ROITop)),this.whereHappened=[r[this.handleClicked][0],r[this.handleClicked][1]],n={"slot":"points","value":r},n):undefined},K2.Curve.prototype.dragend=K2.Curve.prototype.swipe=function(e,t){if(e<0&&t<0)return;var n=this.drag(e,t);return this.handleClicked=null,n},K2.Curve.prototype.release=K2.Curve.prototype.mouseup=function(e,t){this.handleClicked=null;if(this.selectStart===!0&&this.isInCurve(e,t)){this.selectStart=!1;var n={"slot":"selected","value":[e,t]};return n}},K2.Curve.prototype.hold=function(e,t){if(this.isInROI(e,t)&&this.isInCurve(e,t)){var n={"slot":"held","value":[e,t]};return n}},K2.Curve.prototype.doubletap=function(e,t){if(this.isInROI(e,t)){var n;if((n=this.isInHandle(e,t))!==null)return{"slot":"doubletap_h","value":[[e,t],n]};if(this.isInCurve(e,t))return{"slot":"doubletap_c","value":[e,t]}}},K2.Curve.prototype.setValue=function(e,t){var n=!0;if(e==="points"){var r=this.values[e];for(var i=0;i<t.length;i+=1){for(var s=0;s<t.length;s+=1)if(t[i][s]!==r[i][s]){n=!1;break}if(n===!1)break}}else n=!1;this.xMonotone&&this.xMonotoneFunc(t),n||K2.Curve.superclass.setValue.call(this,e,t)},K2.Curve.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=e.context,n=this.values.points,r={"thickness":this.thickness,"curveColor":this.curveColor,"helperColor":this.helperColor,"handleColor":this.handleColor,"handleSize":this.handleSize,"curveLabels":this.curveLabels};this.genericCurve(this.values.points,this.curveType),this.paintCurve(t),this.paintPoints(t,this.values.points,r)}},K2.Curve.prototype.getCurvePoints=function(e){var t=1/e,n=[];for(var r=0;r<=1;r+=t){var i=this[this.curveType].P(r,this.values.points);n.push(i)}return n},K2.Curve.prototype.getCurveYPoints=function(e,t){typeof t=="undefined"&&(t=1);var n=1/e,r=[];for(var i=0;i<=1;i+=n){var s=this[this.curveType].P(i,this.values.points)[1]*t;r.push(s)}return r},K2.Curve.prototype.getPoint=function(e){return this.supportPoints[e]},K2.Curve.prototype.getnumPoints=function(){return this.supportPoints.length},K2.Curve.prototype.halfcosine={"P":function(e,t){var n=(1-Math.cos(e*Math.PI))/2,r=[0,0];return r[0]=t[0][0]+(t[1][0]-t[0][0])*e,r[1]=t[0][1]*(1-n)+t[1][1]*n,r}},K2.Curve.prototype.smooth={"P":function(e,t){var n=e*e*(3-2*e),r=[0,0];return r[0]=t[0][0]+(t[1][0]-t[0][0])*e,r[1]=t[0][1]+n*(t[1][1]-t[0][1]),r}},K2.Curve.prototype.linear={"P":function(e,t){var n=[0,0];return n[0]=t[0][0]+(t[1][0]-t[0][0])*e,n[1]=t[0][1]*(1-e)+t[1][1]*e,n}},K2.Curve.prototype.cubic={"P":function(e,t){var n=[0,0];n[0]=t[0][0]+(t[3][0]-t[0][0])*e;var r=e,i=e*e,s=t[3][1]-t[2][1]-t[0][1]+t[1][1],o=t[0][1]-t[1][1]-s,u=t[2][1]-t[0][1],a=t[1][1];return n[1]=s*r*i+o*i+u*r+a,n}},K2.Curve.prototype.catmull={"P":function(e,t){var n=[0,0];n[0]=t[0][0]+(t[3][0]-t[0][0])*e;var r=e,i=e*e,s=t[0][1],o=t[1][1],u=t[2][1],a=t[3][1],f=-0.5*s+1.5*o-1.5*u+.5*a,l=s-2.5*o+2*u-.5*a,c=-0.5*s+.5*u,h=o;return n[1]=f*r*i+l*i+c*r+h,n}},K2.Curve.prototype.hermite={"P":function(e,t,n,r){var i=[0,0];i[0]=t[0][0]+(t[3][0]-t[0][0])*e;var s=r||0,o=n||0,u,a,f,l,c,h,p,d,v=e,m=t[0][1],g=t[1][1],y=t[2][1],b=t[3][1];return f=v*v,l=f*v,u=(g-m)*(1+s)*(1-o)/2,u+=(y-g)*(1-s)*(1-o)/2,a=(y-g)*(1+s)*(1-o)/2,a+=(b-y)*(1-s)*(1-o)/2,c=2*l-3*f+1,h=l-2*f+v,p=l-f,d=-2*l+3*f,i[1]=c*g+h*u+p*a+d*y,i}},K2.Curve.prototype.bezier={"P":function(e,t){function r(e,t,r){var i=n;return typeof fact_lookup=="function"&&(i=fact_lookup),i(t)/(i(e)*i(t-e))*Math.pow(r,e)*Math.pow(1-r,t-e)}var n=function(e){var t=1;for(var n=2;n<=e;n++)t*=n;return t},i=[0,0],s=t.length-1;for(var o=0;o<=s;o++)i[0]+=t[o][0]*r(o,s,e),i[1]+=t[o][1]*r(o,s,e);return i}},K2.Curve.prototype.genericCurve=function(e,t){function n(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function r(e){var t=0;for(var r=0;r<e.length-1;r++)t+=n(e[r],e[r+1]);var i=1/t;return i}function i(e,t){var n=r(e),i=[];for(var s=0;s<=1;s+=n){var o=t.P(s,e);i.push(o)}return i}this.supportPoints=i(e,this[t])},K2.Curve.prototype.paintHandle=function(e,t,n){n===!0?this.paintPoint(e,t,this.terminalPointStyle,this.terminalPointFill,this.terminalPointColor,this.terminalPointSize):this.paintPoint(e,t,this.midPointStyle,this.midPointFill,this.midPointColor,this.midPointSize)},K2.Curve.prototype.paintPoint=function(e,t,n,r,i,s){if(n==="rect")e.save(),e.strokeStyle=i,e.lineWidth=Math.round(s/5),e.strokeRect(t[0]-Math.round(s/2),t[1]-Math.round(s/2),s,s),r!==null&&(e.fillStyle=r,e.fillRect(t[0]-Math.ceil(s/2)+Math.floor(e.lineWidth/2),t[1]-Math.ceil(s/2)+Math.floor(e.lineWidth/2),s-e.lineWidth+1,s-e.lineWidth+1)),e.restore();else if(n==="circle")e.save(),e.beginPath(),e.strokeStyle=i,e.lineWidth=Math.round(s/5),e.arc(t[0],t[1],s,0,2*Math.PI,!1),r!==null&&(e.fillStyle=r,e.fill()),e.stroke(),e.restore();else if(n!=="none")throw"Unknown handle style: "+n},K2.Curve.prototype.paintPoints=function(e,t){var n=this.values.points,r;e.save(),e.strokeStyle=this.helperColor,e.beginPath(),e.moveTo(n[0][0],n[0][1]);for(r=1;r<n.length;r++)e.lineTo(n[r][0],n[r][1]);e.stroke();for(r=0;r<n.length;r++){var i=!1;if(r===0||r===n.length-1)i=!0;var s=this.paintTerminalPoints;if(i===!0){if(s==="all"||s==="first"&&r===0||s==="last"&&r===n.length-1)this.paintHandle(e,n[r],i),this.curveLabels&&e.fillText(this.ID+" ("+r+")"+" ["+n[r][0]+","+n[r][1]+"]",n[r][0],n[r][1]-10)}else this.paintHandle(e,n[r],i),this.curveLabels&&e.fillText(this.ID+" ("+r+")"+" ["+n[r][0]+","+n[r][1]+"]",n[r][0],n[r][1]-10);e.restore()}},K2.Curve.prototype.paintCurve=function(e){var t=this.supportPoints,n=this.thickness,r=this.curveColor;e.save(),e.lineWidth=n,e.strokeStyle=r,e.beginPath(),e.moveTo(t[0][0],t[0][1]);for(var i=1;i<t.length;i++)e.lineTo(t[i][0],t[i][1]);e.stroke(),e.restore()},K2.Bar=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Bar,K2.UIElement),K2.Bar.prototype.getready=function(e){K2.Bar.superclass.getready.call(this,e),this.values={"barPos":[],"dragStart":[],"dragEnd":[]},this.defaultSlot="barPos",this.setWidth(e.width),this.setHeight(e.height),this.orientation=e.orientation||0,this.barColor=e.barColor||"black",this.thickness=e.thickness||1},K2.Bar.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Bar.prototype.isInROIX=function(e){return e>this.ROILeft&&e<this.ROILeft+this.ROIWidth?!0:!1},K2.Bar.prototype.isInROIY=function(e){return e>this.ROITop&&e<this.ROITop+this.ROIHeight?!0:!1},K2.Bar.prototype.commonDrag=function(e,t){var n,r=this.values.barPos;if(this.orientation===0){if(!this.isInROIY(t))return;n=[e-this.xOrigin,r[1]],n[0]>this.width&&(n[0]=this.width),n[0]<0&&(n[0]=0)}else if(this.orientation===1){if(!this.isInROIY(e))return;n=[r[0],t-this.yOrigin],n[1]>this.height&&(n[1]=this.height),n[1]<0&&(n[1]=0)}return n},K2.Bar.prototype.mousedown=K2.Bar.prototype.touchstart=function(e,t){if(!this.isInROI(e,t))return;this.started=!0;var n=this.commonDrag(e,t);if(typeof n!="undefined")return ret={"slot":"barPos","value":n},ret},K2.Bar.prototype.drag=function(e,t){if(!this.started)return;var n=this.commonDrag(e,t);if(typeof n!="undefined")return ret={"slot":"barPos","value":n},ret},K2.Bar.prototype.dragend=K2.Bar.prototype.swipe=function(e,t){if(!this.started)return;this.started=!1;var n=this.commonDrag(e,t);if(typeof n!="undefined")return ret=[{"slot":"barPos","value":n},{"slot":"dragEnd","value":[e-this.xOrigin,t-this.yOrigin]}],ret},K2.Bar.prototype.dragstart=function(e,t){if(this.isInROI(e,t))return ret={"slot":"dragStart","value":[e-this.xOrigin,t-this.yOrigin]},ret},K2.Bar.prototype.setValue=function(e,t){console.log("Setting "+e+" to "+t),e=="barPos"?(t[0]<=this.width&&(this.values.barPos[0]=t[0]),t[1]<=this.height&&(this.values.barPos[1]=t[1])):this.values[e]=t},K2.Bar.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=e.context;t.lineWidth=this.thickness,t.strokeStyle=this.barColor,t.beginPath();if(this.orientation===0){var n=this.xOrigin+this.values.barPos[0];t.moveTo(n,this.yOrigin+this.height),t.lineTo(n,this.yOrigin)}else this.orientation===1&&(t.moveTo(this.xOrigin+this.width,this.yOrigin+this.values.barPos[1]),t.lineTo(this.xOrigin,this.yOrigin+this.values.barPos[1]));t.stroke(),t.closePath()}},K2.Button=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Button,K2.UIElement),K2.Button.prototype.getready=function(e){if(e===undefined)throw new Error("Error: args is undefined!");K2.Button.superclass.getready.call(this,e),this.values={"buttonvalue":0},this.defaultSlot="buttonvalue",this.triggered=!1,this.mode=e.mode||"persistent",this.imagesArray=e.imagesArray;if(this.imagesArray.length<1)throw new Error("Invalid images array length, "+this.imagesArray.length);this.nButtons=this.imagesArray.length;for(var t=0;t<this.nButtons;t+=1)this.setWidth(this.imagesArray[t].width),this.setHeight(this.imagesArray[t].height)},K2.Button.prototype.isInROI=function(e,t){return e>=this.ROILeft&&t>=this.ROITop&&e<=this.ROILeft+this.ROIWidth&&t<=this.ROITop+this.ROIHeight?!0:!1},K2.Button.prototype.mousedown=K2.Button.prototype.touchstart=function(e,t){if(this.isInROI(e,t)){this.triggered=!0;if(this.mode==="persistent")return undefined;if(this.mode==="immediate")return to_set=(this.values.buttonvalue+1)%this.nButtons,ret={"slot":"buttonvalue","value":to_set},ret}},K2.Button.prototype.mouseup=K2.Button.prototype.touchend=function(e,t){var n=0,r={};if(this.mode==="persistent"){if(this.triggered&&this.isInROI(e,t))return n=(this.values.buttonvalue+1)%this.nButtons,r={"slot":"buttonvalue","value":n},this.triggered=!1,r}else if(this.mode==="immediate"&&this.triggered)return n=(this.values.buttonvalue-1)%this.nButtons,r={"slot":"buttonvalue","value":n},this.triggered=!1,r;return undefined},K2.Button.prototype.mouseout=function(e,t){if(this.mode==="immediate")return this.mouseup(e,t)},K2.Button.prototype.setValue=function(e,t){if(t<0||t>this.nButtons)return;K2.Button.superclass.setValue.call(this,e,t)},K2.Button.prototype.refresh_CANVAS2D=function(e){this.isVisible===!0&&e.context.drawImage(this.imagesArray[this.values.buttonvalue],this.xOrigin,this.yOrigin)},K2.Button.prototype.setStatesNumber=function(e){this.nButtons=e},K2.Button.prototype.getStatesNumber=function(){return this.nButtons},K2.Background=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Background,K2.UIElement),K2.Background.prototype.getready=function(e){if(typeof e=="undefined")throw new Error("Error: args is undefined!");K2.Background.superclass.getready.call(this,e),this.values={"selected":[],"held":[],"doubletap":[],"tap":[]},this.defaultSlot="selected",this.image=e.image,this.setWidth(this.image.width),this.setHeight(this.image.height)},K2.Background.prototype.GetImage=function(){return this.image},K2.Background.prototype.isInROI=function(e,t){if(e>this.ROILeft&&t>this.ROITop)return e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Background.prototype.mousedown=function(e,t){return this.isInROI(e,t)&&(this.triggered=!0),undefined},K2.Background.prototype.mouseup=function(e,t){var n=0,r={};return this.triggered&&this.isInROI(e,t)?(r={"slot":"selected","value":[e,t]},this.triggered=!1,r):undefined},K2.Background.prototype.refresh_CANVAS2D=function(e){this.isVisible===!0&&e.context.drawImage(this.image,this.xOrigin,this.yOrigin)},K2.ClickBar=function(e){arguments.length&&this.getready(e)},K2.extend(K2.ClickBar,K2.UIElement),K2.ClickBar.prototype.getready=function(e){var t,n;K2.ClickBar.superclass.getready.call(this,e),this.values={"barvalue":null},this.prevValue=null,this.defaultSlot="barvalue",this.color=e.color||"orangered",this.lightColor=e.diffColor||"darkorange",this.lighterColor=e.prevColor||"orange",this.lightestColor=e.prevColor||"#FFBE00",this.landingHeight=e.landingHeight||20;var r=e.height||0,i=e.width||0;this.maxValue=e.maxValue||1,this.minValue=e.minValue||0,this.setWidth(i),this.setHeight(r)},K2.ClickBar.prototype.isInROI=function(e,t){console.log("y = ",t,"roitop = ",this.ROITop);if(e>=this.ROILeft&&t>=this.ROITop-this.landingHeight){console.log("1st");if(e<=this.ROILeft+this.ROIWidth&&t<=this.ROITop+this.ROIHeight+this.landingHeight)return console.log("In ROI!"),!0}return!1},K2.ClickBar.prototype.calculateValue=function(e,t){var n=t-this.yOrigin;console.log("heigth on click is ",n," pixels");var r=1-n/this.height;return console.log("for a value of ",r," (",n," / ",this.height,")"),r>this.maxValue&&(r=this.maxValue),r<this.minValue&&(r=this.minValue),r},K2.ClickBar.prototype.tap=K2.ClickBar.prototype.touchstart=K2.ClickBar.prototype.mousedown=function(e,t){if(this.isInROI(e,t)){this.triggered=!0;var n=this.calculateValue(e,t);if(n===this.values.barvalue)return;return{"slot":"barvalue","value":n}}},K2.ClickBar.prototype.drag=function(e,t){if(this.isInROI(e,t)){this.triggered||(this.prevValue=this.values.barvalue,this.triggered=!0);var n=this.calculateValue(e,t);if(n===this.values.barvalue)return;return{"slot":"barvalue","value":n}}},K2.ClickBar.prototype.release=K2.ClickBar.prototype.dragend=K2.ClickBar.prototype.mouseup=function(e,t){this.triggered=!1;if(this.prevValue!==this.values.barvalue)return this.prevValue=this.values.barvalue,{"slot":"barvalue","value":this.values.barvalue}},K2.ClickBar.prototype.setValue=function(e,t){K2.ClickBar.superclass.setValue.call(this,e,t)},K2.ClickBar.prototype.refresh_CANVAS2D=function(e){this.isVisible===!0&&(this.triggered?this.values.barvalue<this.prevValue?(e.context.fillStyle=this.lightestColor,e.context.fillRect(this.xOrigin,this.yOrigin+(1-this.prevValue)*this.height,this.width,this.prevValue*this.height),e.context.fillStyle=this.lightColor,e.context.fillRect(this.xOrigin,this.yOrigin+(1-this.values.barvalue)*this.height,this.width,this.values.barvalue*this.height)):(e.context.fillStyle=this.lightColor,e.context.fillRect(this.xOrigin,this.yOrigin+(1-this.values.barvalue)*this.height,this.width,this.values.barvalue*this.height),e.context.fillStyle=this.lighterColor,e.context.fillRect(this.xOrigin,this.yOrigin+(1-this.prevValue)*this.height,this.width,this.prevValue*this.height)):(e.context.fillStyle=this.color,e.context.fillRect(this.xOrigin,this.yOrigin+(1-this.values.barvalue)*this.height,this.width,this.values.barvalue*this.height)))},K2.Gauge=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Gauge,K2.UIElement),K2.Gauge.prototype.getready=function(e){if(typeof e=="undefined")throw new Error("Error: args is undefined!");K2.Gauge.superclass.getready.call(this,e),this.values={"gaugevalue":null,"midgaugevalue":null,"selected":[],"held":[],"doubletap":[],"tap":[]},this.defaultSlot="gaugevalue",this.prevValue=this.values.gaugevalue,this.setWidth(e.width),this.setHeight(e.height),this.color=e.color||["#47D147","#70DB70","#99E699"],this.bgColor=e.bgColor||"#222",this.radius=e.radius||(this.width<this.height?Math.floor(this.width/2):Math.floor(this.height/2)),this.thickness=e.thickness||(this.width<this.height?Math.floor(this.width/3):Math.floor(this.height/3)),this.animationInterval=null},K2.Gauge.prototype.isInROI=function(e,t){return!0},K2.Gauge.prototype.calculateAngle=function(e,t){var n=this.xOrigin+this.width/2,r=this.yOrigin+this.height/2;console.log("Point is: ",e,t,"Center is: ",n,r);var i=Math.atan2(e-n,t-r);console.log("radiant atan ",i);var s=i*(180/Math.PI);s=180-s,console.log("degree atan ",s);var o=K2.MathUtils.linearRange(0,360,0,1,Math.floor(s));return o},K2.Gauge.prototype.tap=K2.Gauge.prototype.mousedown=K2.Gauge.prototype.touchstart=function(e,t){var n=K2.MathUtils.distance(e,t,this.xOrigin+this.width/2,this.yOrigin+this.height/2);console.log("dist is, ",n," radius is ",this.radius," thickness is ",this.thickness);if(n>this.radius-this.thickness/2&&n<this.radius+this.thickness/2){console.log("down / tapped Inside the dial"),this.triggered=!0;var r=this.calculateAngle(e,t);this.prevValue=this.values.gaugevalue;var i={"slot":"gaugevalue","value":r};return i}return undefined},K2.Gauge.prototype.drag=K2.Gauge.prototype.mousemove=function(e,t){if(this.triggered){console.log("triggered mousemove");var n=this.calculateAngle(e,t),r={"slot":"gaugevalue","value":n};return r}},K2.Gauge.prototype.release=K2.Gauge.prototype.dragend=K2.Gauge.prototype.mouseup=function(e,t){if(this.triggered){this.triggered=!1,this.prevValue=this.values.gaugevalue;var n={"slot":"gaugevalue","value":this.values.gaugevalue};return n}},K2.Gauge.prototype.setValue=function(e,t){K2.Gauge.superclass.setValue.call(this,e,t)},K2.Gauge.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=e.context;t.beginPath(),this.drawGauge(t,1,this.bgColor),this.triggered?this.values.gaugevalue<=this.prevValue?(this.drawGauge(t,this.prevValue,this.color[2]),this.drawGauge(t,this.values.gaugevalue,this.color[1])):(this.drawGauge(t,this.values.gaugevalue,this.color[2]),this.drawGauge(t,this.prevValue,this.color[1])):this.drawGauge(t,this.values.gaugevalue,this.color[0])}},K2.Gauge.prototype.drawGauge=function(e,t,n){var r,i;r=K2.MathUtils.linearRange(0,1,0,360,t),i=r*Math.PI/180,e.beginPath(),e.strokeStyle=n,e.lineWidth=this.thickness,t===1?e.arc(this.xOrigin+this.width/2,this.yOrigin+this.height/2,this.radius,0,Math.PI*2,!1):e.arc(this.xOrigin+this.width/2,this.yOrigin+this.height/2,this.radius,-90*Math.PI/180,i-90*Math.PI/180,!1),e.stroke()},K2.Grid=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Grid,K2.UIElement),K2.Grid.prototype.getready=function(e){if(e===undefined)throw new Error("Error: args is undefined!");K2.Grid.superclass.getready.call(this,e),this.setWidth(e.width),this.setHeight(e.height),this.values={"selected":[]},this.defaultSlot="",this.triggered=!1,this.rows=e.rows||4,this.columns=e.columns||4,this.style=e.style||"line",this.lineColor=e.lineColor||"#eee",this.bgColor=e.bgColor||"white",this.dashArray=e.dashArray,this.lineWidth=e.lineWidth||.1;if(this.rows<0||this.columns<0)throw new Error("Invalid number of row / columns "+this.rows+" / "+this.columns)},K2.Grid.prototype.isInROI=function(e,t){return e>=this.ROILeft&&t>=this.ROITop&&e<=this.ROILeft+this.ROIWidth&&t<=this.ROITop+this.ROIHeight?!0:!1},K2.Grid.prototype.mousedown=function(e,t){return this.isInROI(e,t)&&(this.triggered=!0),undefined},K2.Grid.prototype.mouseup=function(e,t){return this.triggered&&this.isInROI(e,t)?(this.triggered=!1,{"slot":"selected","value":[e,t]}):undefined},K2.Grid.prototype.setValue=function(e,t){K2.Grid.superclass.setValue.call(this,e,t)},K2.Grid.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=e.context,n=Math.floor(this.height/this.rows),r=Math.floor(this.width/this.columns);t.fillStyle=this.bgColor,t.fillRect(this.xOrigin,this.yOrigin,this.width,this.height),t.beginPath(),t.lineWidth=this.lineWidth;for(var i=this.xOrigin+0;i<this.xOrigin+this.width;i+=r)this.style==="line"?(t.moveTo(i,this.yOrigin),t.lineTo(i,this.yOrigin+this.height)):this.style==="dashed"&&t.dashedLine(i,this.yOrigin,i,this.yOrigin+this.height,this.dashArray);for(var s=this.yOrigin+0;s<this.yOrigin+this.height;s+=n)this.style==="line"?(t.moveTo(this.xOrigin,s),t.lineTo(this.xOrigin+this.width,s)):this.style==="dashed"&&t.dashedLine(this.xOrigin,s,this.xOrigin+this.width,s,this.dashArray);t.strokeStyle=this.lineColor,t.stroke(),t.closePath()}},K2.Knob=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Knob,K2.UIElement),K2.Knob.prototype.getready=function(e){if(e===undefined)throw new Error("Error: specArgs is undefined!");K2.Knob.superclass.getready.call(this,e),this.values={"knobvalue":0},this.defaultSlot="knobvalue",this.sensitivity=e.sensitivity||2e3,this.imagesArray=e.imagesArray||null,this.knobMethod=e.knobMethod||"atan",this.bottomAngularOffset=e.bottomAngularOffset;var t=0,n=0;if(this.imagesArray.length<1)throw new Error("Invalid images array length, "+this.imagesArray.length);if(this.imagesArray.length==1)t=e.tileWidth,n=e.tileHeight,this.imageNum=e.imageNum;else{this.imageNum=this.imagesArray.length;for(var r=0,i=this.imagesArray.length;r<i;r+=1)this.imagesArray[r].width>t&&(t=this.imagesArray[r].width),this.imagesArray[r].height>n&&(n=this.imagesArray[r].height)}this.setWidth(t),this.setHeight(n)},K2.Knob.prototype.getImageNum=function(){if(this.values.knobvalue<0||this.values.knobvalue>1)return undefined;var e=Math.round(this.values.knobvalue*(this.imageNum-1));return e},K2.Knob.prototype.getImage=function(){var e=this.getImageNum();return this.imagesArray[e]},K2.Knob.prototype.calculateAngle=function(e,t){var n=this.xOrigin+this.width/2,r=this.yOrigin+this.height/2;console.log("Point is: ",e,t,"Center is: ",n,r);var i=Math.atan2(e-n,t-r);console.log("radiant atan ",i),i<0&&(i+=2*Math.PI),console.log("radiant atan, normalized, is ",i);var s=i*(180/Math.PI);console.log("degree atan is",s),s=360-s,typeof this.bottomAngularOffset!="undefined"&&(s=K2.MathUtils.linearRange(0,360,-this.bottomAngularOffset,360+this.bottomAngularOffset,s),s<0&&(s=0),s>360&&(s=360));var o=K2.MathUtils.linearRange(0,360,0,1,Math.floor(s));return console.log("value is",o),o},K2.Knob.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Knob.prototype.dragstart=K2.Knob.prototype.mousedown=K2.Knob.prototype.touchstart=function(e,t){var n=this.isInROI(e,t);if(n){this.start_x=e,this.start_y=t;if(this.knobMethod==="atan"){var r=this.calculateAngle(e,t),i={"slot":"knobvalue","value":r};return i}}return undefined},K2.Knob.prototype.dragend=K2.Knob.prototype.mouseup=function(e,t){return this.start_x=undefined,this.start_y=undefined,undefined},K2.Knob.prototype.drag=K2.Knob.prototype.mousemove=function(e,t){var n;if(this.knobMethod==="updown"){if(this.start_x!==undefined&&this.start_y!==undefined){var r=0,i,s;return r=t-this.start_y,i=this.values.knobvalue,s=i-r/this.sensitivity,s>1&&(s=1),s<0&&(s=0),n={"slot":"knobvalue","value":s},n}}else if(this.knobMethod==="atan"&&this.start_x!==undefined&&this.start_y!==undefined){var o=this.calculateAngle(e,t);return n={"slot":"knobvalue","value":o},n}return undefined},K2.Knob.prototype.setValue=function(e,t){var n=t;if(n<0||n>1)return;K2.Knob.superclass.setValue.call(this,e,t)},K2.Knob.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0)if(this.imagesArray.length>1){var t=this.getImageNum();e.context.drawImage(this.imagesArray[t],this.xOrigin,this.yOrigin)}else if(this.imagesArray.length==1){var n=0,r=this.height*this.getImageNum();e.context.drawImage(this.imagesArray[0],n,r,this.width,this.height,this.xOrigin,this.yOrigin,this.width,this.height)}},K2.Label=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Label,K2.UIElement),K2.Label.prototype.getready=function(e){K2.Label.superclass.getready.call(this,e),this.values={"labelvalue":""},this.defaultSlot="labelvalue",this.textColor=e.textColor||"black",this.setWidth(e.width),this.setHeight(e.height)},K2.Label.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Label.prototype.setValue=function(e,t){K2.Label.superclass.setValue.call(this,e,t)},K2.Label.prototype.refresh_CANVAS2D=function(e){var t;this.isVisible===!0&&(typeof this.objParms!="undefined"&&(typeof this.objParms.textBaseline!="undefined"&&(e.context.textBaseline=this.objParms.textBaseline),typeof this.objParms.textAlign!="undefined"&&(e.context.textAlign=this.objParms.textAlign),typeof this.objParms.font!="undefined"&&(e.context.font=this.objParms.font)),e.context.fillStyle=this.textColor,e.context.fillText(this.values.labelvalue,this.xOrigin,this.yOrigin))},K2.RotKnob=function(e){arguments.length&&this.getready(e)},K2.extend(K2.RotKnob,K2.UIElement),K2.RotKnob.prototype.getready=function(e){if(typeof e=="undefined")throw"RotKnob constructor: args is undefined!";K2.RotKnob.superclass.getready.call(this,e),this.values={"knobvalue":0,"realknobvalue":0},this.defaultSlot="knobvalue",e.initAngValue===undefined?this.initAngValue=0:this.initAngValue=e.initAngValue,e.moveDirection=="anticlockwise"?this.moveDirection=-1:this.moveDirection=1,this.startAngValue=e.startAngValue||0,this.stopAngValue=e.stopAngValue||360,this.angSteps=e.angSteps;var t=e.sensitivity||2e3;this.sensitivity=Math.round(t/360*Math.abs(this.stopAngValue-this.startAngValue)),this.knobMethod=e.knobMethod||"atan",this.image=e.image,this.setWidth(this.image.width),this.setHeight(this.image.height),this.start_x=null,this.start_y=null},K2.RotKnob.prototype.getRotateAmount=function(){if(this.values.knobvalue<0||this.values.knobvalue>1)return undefined;var e=this.values.knobvalue*360,t=360-(e*(this.startAngValue-this.stopAngValue)/360+this.stopAngValue)%360,n=(360-this.initAngValue+t)%360,r=n*Math.PI/180;return r},K2.RotKnob.prototype.getRangedAmount=function(e){var t=this.stopAngValue-this.initAngValue,n=this.startAngValue-this.initAngValue;console.log("start -> end",n,t),e>this.initAngValue&&n<0&&(console.log("Angle now is",e),e=-(360-e));var r=K2.MathUtils.linearRange(n,t,0,1,e);return console.log("knob value",r),r<0&&(r=0),r>1&&(r=1),r},K2.RotKnob.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.RotKnob.prototype.calculateAngle=function(e,t){var n=this.xOrigin+this.width/2,r=this.yOrigin+this.height/2;console.log("Point is: ",e,t,"Center is: ",n,r);var i=Math.atan2(e-n,t-r);console.log("radiant atan ",i);var s=i*(180/Math.PI);s=180-s;var o=s-this.initAngValue;o<0&&(o=360+o);var u=(s-this.initAngValue)%360;console.log("degreetan -> offset",s,o,u);var a=this.getRangedAmount(Math.floor(o));return a},K2.RotKnob.prototype.dragstart=K2.RotKnob.prototype.mousedown=K2.RotKnob.prototype.touchstart=function(e,t){var n=this.isInROI(e,t);if(n){this.start_x=e,this.start_y=t;if(this.knobMethod==="atan"){var r=this.calculateAngle(e,t),i={"slot":"knobvalue","value":r};return i}}return undefined},K2.RotKnob.prototype.dragend=K2.RotKnob.prototype.mouseup=K2.RotKnob.prototype.touchend=function(e,t){return this.start_x=null,this.start_y=null,undefined},K2.RotKnob.prototype.drag=K2.RotKnob.prototype.mousemove=function(e,t){var n;if(this.knobMethod==="updown"){if(this.start_x!==null&&this.start_y!==null){var r=0,i,s;return r=t-this.start_y,i=this.values.realknobvalue,s=i-r/this.sensitivity*this.moveDirection,s>1&&(s=1),s<0&&(s=0),n={"slot":"knobvalue","value":s},n}}else if(this.knobMethod==="atan"&&this.isInROI(e,t)&&this.start_x!==null&&this.start_y!==null){var o=this.calculateAngle(e,t);return n={"slot":"knobvalue","value":o},n}return undefined},K2.RotKnob.prototype.setValue=function(e,t){var n;if(t<0||t>1)return;if(this.values[e]===undefined)throw new Error("Slot "+e+" not present or value undefined");if(t===this.values[e]||t===this.values["real"+e])return;this.values["real"+e]=t;if(this.angSteps!==undefined){var r=1/this.angSteps;n=Math.floor(t/r)*r;if(n===this.values[e])return}else n=t;console.log("Value is: ",n),K2.RotKnob.superclass.setValue.call(this,e,n)},K2.RotKnob.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=this.getRotateAmount();K2.CanvasUtils.drawRotate(e.context,{"image":this.image,"x":this.xOrigin,"y":this.yOrigin,"rot":t})}},K2.Slider=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Slider,K2.UIElement),K2.Slider.prototype.getready=function(e){if(typeof e=="undefined")throw"Slider error: args is undefined!";K2.Slider.superclass.getready.call(this,e),this.values={"slidervalue":0},this.defaultSlot="slidervalue",this.width=0,this.height=0,this.sliderImage=e.sliderImg,this.knobImage=e.knobImg,this.type=e.type,this.type!=="horizontal"&&this.type!=="vertical"&&(this.type="vertical"),this.calculateDimensions()},K2.Slider.prototype.getKnobPosition=function(){var e;if(this.values.slidervalue<0||this.values.slidervalue>1)return undefined;switch(this.type){case"horizontal":e=Math.round(this.values.slidervalue*this.width+this.zeroLimit);break;case"vertical":e=Math.round(this.values.slidervalue*this.height+this.zeroLimit);break;default:throw new Error("Error: Slider orientation is undefined!")}return e},K2.Slider.prototype.isInROI=function(e,t){switch(this.type){case"horizontal":if(e>this.getKnobPosition()&&t>this.ROITop&&e<this.getKnobPosition()+this.kWidth&&t<this.ROITop+this.kHeight)return!0;break;case"vertical":if(t>this.getKnobPosition()&&e>this.ROILeft&&t<this.getKnobPosition()+this.kHeight&&e<this.ROILeft+this.kWidth)return!0;break;default:throw new Error("Error: Slider orientation is undefined!")}return!1},K2.Slider.prototype.dragstart=K2.Slider.prototype.mousedown=function(e,t){if(this.isInROI(e,t)){this.triggered=!0;switch(this.type){case"horizontal":this.drag_offset=e-this.getKnobPosition();break;case"vertical":this.drag_offset=t-this.getKnobPosition();break;default:throw new Error("Error: Slider orientation is undefined!")}}return undefined},K2.Slider.prototype.dragend=K2.Slider.prototype.mouseup=function(e,t){return this.triggered=!1,this.drag_offset=undefined,undefined},K2.Slider.prototype.drag=K2.Slider.prototype.mousemove=function(e,t){if(this.triggered===!0){var n,r;switch(this.type){case"horizontal":n=(e-this.zeroLimit-this.drag_offset)/this.width;break;case"vertical":n=(t-this.zeroLimit-this.drag_offset)/this.height;break;default:throw new Error("Error: Slider orientation is undefined!")}return n>1&&(n=1),n<0&&(n=0),r={"slot":"slidervalue","value":n},r}return undefined},K2.Slider.prototype.setValue=function(e,t){if(t<0||t>1)return;K2.Slider.superclass.setValue.call(this,e,t)},K2.Slider.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){e.context.drawImage(this.sliderImage,this.xOrigin,this.yOrigin);switch(this.type){case"horizontal":e.context.drawImage(this.knobImage,this.getKnobPosition(),this.yOrigin);break;case"vertical":e.context.drawImage(this.knobImage,this.xOrigin,this.getKnobPosition());break;default:throw new Error("Error: Slider orientation unknown: ",this.type)}}},K2.Slider.prototype.calculateDimensions=function(){this.kWidth=this.knobImage.width,this.kHeight=this.knobImage.height,this.setWidth(this.sliderImage.width),this.setHeight(this.sliderImage.height);switch(this.type){case"horizontal":this.totalStride=this.width+this.kWidth,this.additionalEndSpace=Math.round(this.kWidth/2),this.zeroLimit=this.xOrigin-this.additionalEndSpace,this.oneLimit=this.xOrigin+this.width+this.additionalEndSpace;break;case"vertical":this.totalStride=this.height+this.kHeight,this.additionalEndSpace=Math.round(this.kHeight/2),this.zeroLimit=this.yOrigin-this.additionalEndSpace,this.oneLimit=this.yOrigin+this.height+this.additionalEndSpace;break;default:throw new Error("Error: Slider orientation is undefined!")}},K2.Slider.prototype.setGraphicWrapper=function(e){K2.Slider.superclass.setGraphicWrapper.call(this,e),this.drawClass=e.initObject([{"objName":"drawImage","objParms":this.objParms}])},K2.Wavebox=function(e){arguments.length&&this.getready(e)},K2.extend(K2.Wavebox,K2.UIElement),K2.Wavebox.prototype.getready=function(e){K2.Wavebox.superclass.getready.call(this,e),this.values={"waveboxposition":0,"startsample":0,"endsample":null,"waveboxsignal":[],"xPos":0,"yPos":0},this.defaultSlot="waveboxposition",this.setWidth(e.width),this.setHeight(e.height),this.binMethod=e.binMethod||"minmax",this.orientation=e.orientation||0,this.waveColor=e.waveColor||"black"},K2.Wavebox.prototype.isInROI=function(e,t){return e>this.ROILeft&&t>this.ROITop&&e<this.ROILeft+this.ROIWidth&&t<this.ROITop+this.ROIHeight?!0:!1},K2.Wavebox.prototype.tap=K2.Wavebox.prototype.mousedown=function(e,t){return this.isInROI(e,t)&&(this.triggered=!0),undefined},K2.Wavebox.prototype.release=K2.Wavebox.prototype.mouseup=function(e,t){var n=0,r={};return this.triggered&&this.isInROI(e,t)?(this.orientation===0?r={"slot":"xPos","value":e}:this.orientation===1?r={"slot":"yPos","value":t}:console.error("orientation invalid, this will probably break something"),this.triggered=!1,r):undefined},K2.Wavebox.prototype.setValue=function(e,t){console.log("Setting "+e+" to "+t);if(this.values[e]===undefined)throw new Error("Slot "+e+" not present or value undefined");if(this.values[e]===t)return;if(e==="startsample"||e==="endsample"){if(t<0)throw new Error("Error: Trying to set ",e," less than 0: ",t);if(typeof this.values.waveboxsignal!="undefined"&&t>this.values.waveboxsignal.length)throw new Error("Error: Trying to set ",e," bigger than signal length: ",t," > ",this.values.waveboxsignal.length)}if(e==="startsample"&&t>this.values.endsample)throw new Error("Error: Trying to set startsample > endsample: ",t," > ",this.values.endsample);if(e==="endsample"&&t<this.values.startample)throw new Error("Error: Trying to set endsample < startsample: ",t," < ",this.values.startsample);this.values[e]=t,e==="waveboxsignal"&&(this.values.endsample=this.values.waveboxsignal.length,this.values.startsample=0),e=="xPos"&&t<=this.width&&(this.values.xPos=t),e=="yPos"&&(t<=this.height?(console.log("Setting yPos to "+t),this.values.yPos=t):console.log("NOT setting yPos to "+t+" because height is "+this.height))},K2.Wavebox.prototype.refresh_CANVAS2D=function(e){if(this.isVisible===!0){var t=e.context;t.fillStyle=this.waveColor;var n,r,i,s,o=this.width,u=this.height;this.orientation===1&&(o=this.height,u=this.width);var a;this.binMethod=="minmax"?a=this.calculateBinMix:this.binMethod=="none"?a=this.calculateBinNone:console.log("Error: no binMethod!");var f=0;i=parseInt((this.values.endsample-this.values.startsample)/o,10),t.beginPath(),this.orientation===0?t.moveTo(this.xOrigin,u*.5+this.yOrigin):this.orientation===1&&t.moveTo(this.xOrigin+u*.5,this.yOrigin);for(f=0;f<o;f+=1)s=a(f,i,this.values),this.orientation===0?(n=u-(s.max+1)*u/2+this.yOrigin,r=f+this.xOrigin):this.orientation===1&&(n=f+this.yOrigin,r=u-(s.max+1)*u/2+this.xOrigin),t.lineTo(r,n);this.orientation===0?t.lineTo(o+this.xOrigin,u*.5+this.yOrigin):this.orientation===1&&t.lineTo(u*.5+this.xOrigin,o+this.yOrigin),t.fill(),t.closePath(),t.beginPath(),this.orientation===0?t.moveTo(this.xOrigin,u*.5+this.yOrigin):this.orientation===1&&t.moveTo(this.xOrigin+u*.5,this.yOrigin);for(f=0;f<o;f+=1)s=a(f,i,this.values),this.orientation===0&&(n=u-(s.min+1)*u/2+this.yOrigin,r=f+this.xOrigin),this.orientation===1&&(n=f+this.yOrigin,r=u-(s.min+1)*u/2+this.xOrigin),t.lineTo(r,n);this.orientation===0?t.lineTo(o+this.xOrigin,u*.5+this.yOrigin):this.orientation===1&&t.lineTo(u*.5+this.xOrigin,o+this.yOrigin),t.fill(),t.closePath()}},K2.Wavebox.prototype.calculateBinMix=function(e,t,n){var r=n.waveboxsignal,i=n.startsample+e*t,s=n.startsample+(e+1)*t;s>n.endsample&&(s=n.endsample);var o=r[i],u=r[i];for(var a=1;a<t;a++)r[i+a]<o&&(o=r[i+a]),r[i+a]>u&&(u=r[i+a]);var f={"max":u,"min":o};return f},K2.Wavebox.prototype.calculateBinNone=function(e,t,n){var r=n.startsample+e*t,i=parseInt(t/2,10),s=n.waveboxsignal[r+i],o={"max":s,"min":-s};return o},K2.Wavebox.prototype.calculateBinAvg=function(e,t){var n=this.values.waveboxsignal,r=this.values.startsample+e*t,i=r+(e+1)*t;i>this.values.endsample&&(i=this.values.endsample);var s=n.subarray(r,i),o=0,u=s.length;for(var a=0;a<u-1;a++)o=(s[a+1]+a*o)/(a+1);return o};var CurveEditor=function(e){this.setVisible=function(e){for(var t=0;t<this.status.curveArray.length;t+=1)this.ui.setVisible(this.status.curveArray[t],e)},this.setzIndex=function(e){this.Z_OFFSET=e,this.reorganizeElements(),this.ui.refresh()},this.setTransparency=function(e){for(var t=0;t<this.status.curveArray.length;t+=1){var n=this.ui.getElement(this.status.curveArray[t]);n.transparency=e}this.ui.refresh()},this.setListening=function(e){for(var t=0;t<this.status.curveArray.length;t+=1)this.ui.setListening(this.status.curveArray[t],e)},this.reorganizeElements=function(){var e=function(e,t){var n=K2.GenericUtils.clone(t.ui.getProp(t.recv,"values").points),r=K2.GenericUtils.clone(t.ui.getProp(t.sender,"values").points);return n[n.length-1]=r[0],n};this.ui.resetSlots();for(var t=0;t<this.status.curveArray.length;t+=1)this.ui.setZIndex(this.status.curveArray[t],t+this.Z_OFFSET),t<this.status.curveArray.length-1&&this.ui.connectSlots(this.status.curveArray[t+1],"points",this.status.curveArray[t],"points",{"callback":e,"cascade":!1});if(this.xMonotone)for(t=0;t<this.status.curveArray.length-1;t+=1){var n=this.ui.getElement(this.status.curveArray[t]),r=this.ui.getElement(this.status.curveArray[t+1]);n.ROIWidth=r.values.points[0][0]-n.ROILeft,r.ROILeft=n.values.points[0][0]}},this.callback=function(){var e=this;return function(t,n,r){console.log("Element: ",r,". onValueSet callback: slot is ",t," and value is ",n," while that is ",e),typeof e.externalCallback=="function"&&e.externalCallback(t,n,r);if(t==="selected")for(var i=0;i<e.status.curveArray.length;i+=1)e.status.curveArray[i]===r?(e.ui.setProp(r,"curveColor",e.selectedCurveColor),e.status.selected=i):e.ui.setProp(e.status.curveArray[i],"curveColor",e.curveArgsTemplate.curveColor);t==="held";if(t==="doubletap_c"){var s=e.ui.getProp(r,"values").points,o=K2.GenericUtils.clone(e.curveArgsTemplate);o.curveType="linear",o.ID="curve"+e.status.nextNumber++;if(e.status.selected<e.status.curveArray.length-1){o.paintTerminalPoints="first",s[s.length-1]=n;var u=e.status.curveArray[e.status.selected+1],a=e.ui.getProp(u,"values").points;o.points=[n[0],n[1],a[0][0],a[0][1]]}else{e.ui.setProp(r,"paintTerminalPoints","first"),o.paintTerminalPoints="all";var f=K2.GenericUtils.clone(s[s.length-1]);s[s.length-1]=n,o.points=[n[0],n[1],f[0],f[1]]}var l=new K2.Curve(o);e.ui.addElement(l),e.status.curveArray.splice(e.status.selected+1,0,o.ID)}console.log("Reorganizing elements"),e.reorganizeElements(),e.ui.refresh()}},this.clearCurve=function(){for(var e=0;e<this.status.curveArray.length;e+=1)this.ui.removeElement(this.status.curveArray[e]);this.status.curveArray=[],this.status.selected=null,this.ui.refresh()},this.addCurve=function(e,t,n,r){console.log("Adding a curve");var i,s=K2.GenericUtils.clone(this.curveArgsTemplate);s.ID="curve"+this.status.nextNumber++;var o=t,u,a,f=[];s.paintTerminalPoints="all";if(typeof n!="undefined")u=n;else if(this.status.curveArray.length===0)u=[0,this.height];else{i=this.status.curveArray[this.status.curveArray.length-1];var l=this.ui.getProp(i,"values").points;u=[l[l.length-1][0],l[l.length-1][1]],this.ui.setProp(i,"paintTerminalPoints","first")}var c=Math.round(this.width/8),h=-Math.round(this.height/8);if(typeof r!="undefined")a=r;else{a=[u[0]+c,u[1]+h],a[0]>this.width&&(a[0]=this.width),a[1]<0&&(a[1]=0);if(a[0]===this.lastCalculatedPoint[0]&&a[1]===this.lastCalculatedPoint[1]){console.log("Remove something before adding stuff"),this.ui.setProp(i,"paintTerminalPoints","all");return}}this.lastCalculatedPoint[0]=a[0],this.lastCalculatedPoint[1]=a[1];switch(e){case"linear":case"smooth":case"halfcosine":s.points=u.concat(a);break;case"bezier":var p=u.slice();for(var d=1;d<o;d+=1)p[0]+=20,p[1]-=20,f=f.concat(p);s.points=u.concat(f,a)}s.curveType=e;var v=new K2.Curve(s);this.ui.addElement(v),this.status.curveArray.push(s.ID),this.reorganizeElements(),this.ui.refresh()},this.removeCurve=function(){var e;if(this.status.selected!==null){console.log("Deleting selected curve "+this.status.selected);if(this.status.selected!==0&&this.status.selected<this.status.curveArray.length-1){var t=this.status.curveArray[this.status.selected+1];e=this.status.curveArray[this.status.selected-1];var n=this.ui.getProp(t,"values"),r=this.ui.getProp(e,"values"),i=K2.GenericUtils.clone(n);i.points[0][0]=r.points[r.points.length-1][0],i.points[0][1]=r.points[r.points.length-1][1],this.ui.setProp(t,"values",i)}this.status.selected===this.status.curveArray.length-1&&this.status.selected!==0&&(e=this.status.curveArray[this.status.selected-1],this.ui.setProp(e,"paintTerminalPoints","all")),this.ui.removeElement(this.status.curveArray[this.status.selected]),this.status.curveArray.splice(this.status.selected,1),this.status.selected=null,this.reorganizeElements(),this.ui.refresh()}},this.modifyCurve=function(e,t){var n;if(this.status.selected!==null){console.log("Transforming selected curve "+this.status.selected);var r=t,i=this.ui.getProp(this.status.curveArray[this.status.selected],"curveType"),s=K2.GenericUtils.clone(this.ui.getProp(this.status.curveArray[this.status.selected],"values")),o=s.points,u=o.length-1;if(i===e){if(e!=="bezier"){console.log("Identical type, doing nothing");return}if(r===u){console.log("Identical type and grade, doing nothing");return}}var a=o[0],f=[],l=[a[0],a[1]];if(e==="bezier")for(n=1;n<r;n+=1)l[0]+=20,l[1]-=20,f=f.concat(l);var c=o[o.length-1],h=a.concat(f,c),p=[];for(n=0;n<h.length;n+=2)p.push([h[n],h[n+1]]);s.points=p,this.ui.setProp(this.status.curveArray[this.status.selected],"curveType",e),this.ui.setProp(this.status.curveArray[this.status.selected],"values",s),this.reorganizeElements(),this.ui.refresh()}},this.ui=e.ui,this.plugin_canvas=e.canvas,this.status={"curveArray":[],"selected":null,"nextNumber":0},this.Z_OFFSET=e.zOffset||0,this.width=e.width||e.canvas.width,this.height=e.height||e.canvas.height,this.lastCalculatedPoint=[],this.selectedCurveColor=e.selectedCurveColor||"red",this.externalCallback=e.callback,this.xMonotone=e.xMonotone,this.curveArgsTemplate={"ID":"","top":0,"left":0,"width":this.width,"height":this.height,"thickness":e.thickness||5,"curveColor":e.curveColor||"02B51F","handleColor":e.handleColor||"A81B32","helperColor":e.helperColor||"gray","curveLabels":e.curveLabels||!0,"midPointSize":e.midPointSize||8,"terminalPointSize":e.terminalPointSize||15,"terminalPointColor":e.terminalPointColor||"black","terminalPointFill":e.terminalPointFill||"015C10","midPointFill":e.midPointFill||"E6965A","isListening":e.isListening||!0,"transparency":e.transparency||.8,"xMonotone":e.xMonotone,"onValueSet":this.callback()}},AreaEditor=function(e){this.reorganizeElements=function(){var e=function(e,t){var n=K2.GenericUtils.clone(t.ui.getProp(t.recv,"values").points),r=K2.GenericUtils.clone(t.ui.getProp(t.sender,"values").points);return n[n.length-1]=r[0],n};this.ui.resetSlots();for(var t=0;t<this.status.areaArray.length;t+=1)this.ui.setZIndex(this.status.areaArray[t],t+this.Z_OFFSET),t<this.status.areaArray.length-1&&this.ui.connectSlots(this.status.areaArray[t+1],"points",this.status.areaArray[t],"points",{"callback":e,"cascade":!1});if(this.xMonotone)for(t=0;t<this.status.areaArray.length-1;t+=1){var n=this.ui.getElement(this.status.areaArray[t]),r=this.ui.getElement(this.status.areaArray[t+1]);n.ROIWidth=r.values.points[0][0]-n.ROILeft,r.ROILeft=n.values.points[0][0]}},this.callback=function(){var e=this;return function(t,n,r){console.log("Element: ",r,". onValueSet callback: slot is ",t," and value is ",n," while that is ",e),typeof e.externalCallback=="function"&&e.externalCallback(t,n,r);if(t==="selected")for(var i=0;i<e.status.areaArray.length;i+=1)e.status.areaArray[i]===r?(e.ui.setProp(r,"color",e.selectedAreaColor),e.status.selected=i):e.ui.setProp(e.status.areaArray[i],"color",e.areaArgsTemplate.color);t==="held";if(t==="doubletap"){var s=e.ui.getElement(r),o=s.values.xOffset,u=s.values.width,a=K2.GenericUtils.clone(e.areaArgsTemplate);a.ID="area"+e.status.nextNumber++,a.xOffset=n[0],a.width=u-(n[0]-o),a.height=s.height,a.yOffset=s.values.yOffset,s.values.width=n[0]-o;var f=new K2.Area(a);e.ui.addElement(f),e.status.areaArray.splice(e.status.selected+1,0,a.ID)}e.ui.refresh()}},this.clearAreas=function(){for(var e=0;e<this.status.areaArray.length;e+=1)this.ui.removeElement(this.status.areaArray[e]);this.status.areaArray=[],this.status.selected=null,this.ui.refresh()},this.addArea=function(e,t){console.log("Adding an area");var n,r=K2.GenericUtils.clone(this.areaArgsTemplate);r.width=e||r.width,r.height=t||r.height,r.ID="area"+this.status.nextNumber++;var i=new K2.Area(r);if(this.status.areaArray.length!==0){n=this.ui.getElement(this.status.areaArray[this.status.areaArray.length-1]);var s=n.values.xOffset,o=n.values.width;i.values.xOffset=s+o}this.ui.addElement(i),this.status.areaArray.push(r.ID),this.ui.refresh()},this.removeArea=function(){var e;this.status.selected!==null},this.ui=e.ui,this.plugin_canvas=e.canvas,this.status={"areaArray":[],"selected":null,"nextNumber":0},this.Z_OFFSET=e.zOffset||0,this.width=e.width||e.canvas.width,this.height=e.height||e.canvas.height,this.lastCalculatedPoint=[],this.selectedAreaColor=e.selectedAreaColor||"red",this.externalCallback=e.callback,this.areaArgsTemplate={"ID":"","top":Math.floor(this.height/2),"left":0,"width":e.defaultWidth||Math.floor(this.height/10),"height":e.defaultHeight||Math.floor(this.height/2),"thickness":e.thickness||5,"color":e.color||"black","borders":e.borders||{"top":!0,"bottom":!0,"right":!0,"left":!0},"move":e.move||"x","dragBorders":{"top":!0,"bottom":!1,"right":!0,"left":!0},"xMonotone":!0,"yMonotone":!0,"isListening":e.isListening||!0,"transparency":e.transparency||.8,"onValueSet":this.callback()}},BarSelect=function(e){this.setVisible=function(){var e,t;arguments.length===1?(e=arguments[0],this.ui.setVisible("tempArea",e),this.ui.setVisible("selectBar",e)):arguments.length===2&&(t=arguments[0],e=arguments[1],this.ui.setVisible(t,e))},this.setTransparency=function(e){this.areaArgsTemplate.transparency=e,this.barArgs.transparency=e;var t=this.ui.getElement("selectBar");t.transparency=e;var n=this.ui.getElement("tempArea");n.transparency=e},this.setzIndex=function(e){this.zIndex=e,this.ui.setZIndex("tempArea",e),this.ui.setZIndex("selectBar",e+1)},this.setListening=function(e){this.ui.setListening("tempArea",e),this.ui.setListening("selectBar",e)},this.callback=function(){var e=this;return function(t,n,r){console.log("Element: ",r,". onValueSet callback: slot is ",t," and value is ",n," while that is ",e);var i;if(t==="dragStart"){console.log("Storing dragStart value ",n),e.dragStart=n;if(e.areaElement===null){e.ui.isElement(e.areaArgsTemplate.ID)&&e.ui.removeElement(e.areaArgsTemplate.ID);var s=K2.GenericUtils.clone(e.areaArgsTemplate);e.areaElement=new K2.Area(s)}e.areaElement.values.xOffset=e.dragStart[0],e.areaElement.values.width=0,e.selectStart=e.dragStart[0],e.selectWidth=0,e.ui.addElement(e.areaElement,{"zIndex":this.zIndex})}t==="barPos"&&(e.dragStart===null&&e.areaElement===null&&e.ui.isElement(e.areaArgsTemplate.ID)&&e.ui.removeElement(e.areaArgsTemplate.ID),e.areaElement!==null&&(i=n[0]-e.dragStart[0],e.areaElement.values.width=i,e.selectWidth=i)),t==="dragEnd"&&e.areaElement!==null&&(i=n[0]-e.dragStart[0],e.areaElement.values.width=i,e.selectWidth=i,e.dragStart=null,e.areaElement=null),typeof e.externalCallback=="function"&&e.externalCallback(t,n,r),e.ui.refresh()}},this.ui=e.ui,this.plugin_canvas=e.canvas,this.areaElement=null,this.zIndex=e.zIndex||0,this.width=e.width||e.canvas.width,this.height=e.height||e.canvas.height,this.externalCallback=e.callback;var t=this.callback();this.areaArgsTemplate={"ID":"tempArea","top":0,"left":0,"width":e.defaultWidth||this.width,"height":e.defaultHeight||this.height,"thickness":e.areaThickness||2,"color":e.areaColor||"black","borderColor":e.areaBorderColor||"gray","borders":{"top":!1,"bottom":!1,"right":!1,"left":!1},"move":e.move||"none","dragBorders":{"top":!1,"bottom":!1,"right":!1,"left":!1},"xMonotone":!0,"yMonotone":!0,"transparency":e.areaTransparency||.5,"isListening":e.isListening||!0,"onValueSet":t},e.areaThickness===0&&(areaArgsTemplate.thickness=0),this.barArgs={"ID":"selectBar","left":0,"top":0,"thickness":e.barThickness||2,"height":this.height,"width":this.width,"onValueSet":t,"barColor":e.barColor||"red","transparency":e.barTransparency||.8,"isListening":e.isListening||!0},this.ui.addElement(new K2.Bar(this.barArgs),{"zIndex":this.zIndex+1}),this.ui.refresh()};K2.ENGINE={},K2.ENGINE.engineFactory=function(e,t){function n(e){this.reset=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},this.canvas=e,this.context=e.getContext("2d"),this.type="CANVAS2D",this.getContext=function(){return this.context},this.getCanvas=function(){return this.canvas}}switch(e){case"CANVAS2D":if(t.target!==undefined)return new n(t.target);throw"Engine: args is undefined";break;case"ANOTHERTYPE":throw"Engine type not recognized: "+e;default:throw"Engine type not recognized: "+e}};var CP=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;CP.lineTo&&(CP.dashedLine=function(e,t,n,r,i){i||(i=[10,5]),this.save();var s=n-e,o=r-t,u=Math.sqrt(s*s+o*o),a=Math.atan2(o,s);this.translate(e,t),this.moveTo(0,0),this.rotate(a);var f=i.length,l=0,c=!0;e=0;while(u>e)e+=i[l++%f],e>u&&(e=u),c?this.lineTo(e,0):this.moveTo(e,0),c=!c;this.restore()}),K2.OSC={},K2.OSC.Message=function(e){this.address=e,this.typetags="",this.args=[];for(var t=1;t<arguments.length;t++){var n=arguments[t];switch(typeof n){case"object":if(!n.typetag)throw new Error("don't know how to encode object "+n);this.typetags+=n.typetag,this.args.push(n);break;case"number":Math.floor(n)==n?(this.typetags+=K2.OSC.TInt.prototype.typetag,this.args.push(new K2.OSC.TInt(Math.floor(n)))):(this.typetags+=K2.OSC.TFloat.prototype.typetag,this.args.push(new K2.OSC.TFloat(n)));break;case"string":this.typetags+=K2.OSC.TString.prototype.typetag,this.args.push(new K2.OSC.TString(n));break;default:throw new Error("don't know how to encode "+n)}}},K2.OSC.Message.prototype={"toBinary":function(){var e=new K2.OSC.TString(this.address),t=[],n=[];n=e.encode(),t=t.concat(n);if(this.typetags){var r=new K2.OSC.TString(","+this.typetags);n=r.encode(),t=t.concat(n);for(var i=0;i<this.args.length;i++)n=this.args[i].encode(),t=t.concat(n)}return t}},K2.OSC.Bundle=function(e,t){K2.OSC.Message.call(this,e),this.timetag=t||0},K2.OSC.Bundle.prototype.append=function(e){var t;if(e instanceof Message)t=new K2.OSC.TBlob(e.toBinary());else{var n=new K2.OSC.Message(this.address);typeof e=="Object"?(e.addr&&(n.address=e.addr),e.args&&n.append.apply(e.args)):n.append(e),t=new K2.OSC.TBlob(n.toBinary())}this.message+=t,this.typetags+="b"},K2.OSC.Bundle.prototype.toBinary=function(){var e=new K2.OSC.TString("#bundle");return e=e.concat(new K2.OSC.TTimeTag(this.timetag)),e=e.concat(this.message),e},K2.OSC.Encoder=function(){},K2.OSC.Encoder.prototype={"encode":function(){var e;if(arguments[0].toBinary)e=arguments[0].toBinary();else{var t={};K2.OSC.Message.apply(t,arguments),e=K2.OSC.Message.prototype.toBinary.call(t)}return e}},K2.OSC.ShortBuffer=function(e,t,n){this.type="ShortBuffer";var r="buffer [";for(var i=0;i<t.length;i++)i&&(r+=", "),r+=t.charCodeAt(i);r+="] too short for "+e+", "+n+" bytes required",this.message=r},K2.OSC.TString=function(e){this.value=e},K2.OSC.TString.prototype={"typetag":"s","decode":function(e){var t=0;while(e[t]&&t<e.length)t++;if(t==e.length)throw Error("OSC string not null terminated");this.value=String.fromCharCode.apply(null,e.slice(0,t));var n=parseInt(Math.ceil((t+1)/4)*4,10);return e.slice(n)},"encode":function(){var e=Math.ceil((this.value.length+1)/4,10)*4,t=new Array(e);return Struct.PackTo(">"+e+"s",t,0,[this.value])}},K2.OSC.TInt=function(e){this.value=e},K2.OSC.TInt.prototype={"typetag":"i","decode":function(e){if(e.length<4)throw new ShortBuffer("int",e,4);return this.value=Struct.Unpack(">i",e.slice(0,4))[0],e.slice(4)},"encode":function(){var e=new Array(4);return Struct.PackTo(">i",e,0,[this.value])}},K2.OSC.TTime=function(e){this.value=e},K2.OSC.TTime.prototype={"typetag":"t","decode":function(e){if(e.length<8)throw new ShortBuffer("time",e,8);return this.value=Struct.Unpack(">LL",e.slice(0,8))[0],e.slice(8)},"encode":function(e,t){return Struct.PackTo(">LL",e,t,this.value)}},K2.OSC.TFloat=function(e){this.value=e},K2.OSC.TFloat.prototype={"typetag":"f","decode":function(e){if(e.length<4)throw new ShortBuffer("float",e,4);return this.value=Struct.Unpack(">f",e.slice(0,4))[0],e.slice(4)},"encode":function(){var e=new Array(4);return Struct.PackTo(">f",e,0,[this.value])}},K2.OSC.TBlob=function(e){this.value=e},K2.OSC.TBlob.prototype={"typetag":"b","decode":function(e){var t=Struct.Unpack(">i",e.slice(0,4))[0],n=parseInt(Math.ceil(t/4)*4,10)+4;return this.value=e.slice(4,t+4),e.slice(n)},"encode":function(e,t){var n=Math.ceil(this.value.length/4,10)*4;return Struct.PackTo(">i"+n+"s",e,t,[n,this.value])}},K2.OSC.TDouble=function(e){this.value=e},K2.OSC.TDouble.prototype={"typetag":"d","decode":function(e){if(e.length<8)throw new ShortBuffer("double",e,8);return this.value=Struct.Unpack(">d",e.slice(0,8))[0],e.slice(8)},"encode":function(e,t){return Struct.PackTo(">d",e,t,[this.value])}},K2.OSC.tagToConstructor={"i":function(){return new K2.OSC.TInt},"f":function(){return new K2.OSC.TFloat},"s":function(){return new K2.OSC.TString},"b":function(){return new K2.OSC.TBlob},"d":function(){return new K2.OSC.TDouble}},K2.OSC.decodeBundle=function(e){var t=[],n={"time":null,"args":[]},r=new K2.OSC.TTime;e=r.decode(e),n.time=r.value;while(e.length>0){var i=new K2.OSC.TInt;e=i.decode(e);var s=K2.OSC.decode(e.slice(0,i.value));n.args.push(s),e=e.slice(i.value)}return t.push(n),t},K2.OSC.decode=function(e){var t=[],n=new K2.OSC.TString;e=n.decode(e),t.push(n.value);if(n.value==="#bundle")return K2.OSC.decodeBundle(e);if(e.length>0){var r=new K2.OSC.TString;e=r.decode(e),r=r.value;if(r[0]!=",")throw"invalid type tag in incoming OSC message, must start with comma";for(var i=1;i<r.length;i++){var s=K2.OSC.tagToConstructor[r[i]];if(!s)throw"Unsupported OSC type tag "+r[i]+" in incoming message";var o=s();e=o.decode(e),t.push(o.value)}}return t},K2.OSC.Decoder=function(){},K2.OSC.Decoder.prototype.decode=function(e){var t=K2.OSC.decode(e);try{if(t)return t}catch(n){console.log("can't decode incoming message: "+n.message)}},K2.OSCClient=function(e,t){this.oscHandler=t,this.clientID=e.clientID,this.oscCallback=e.oscCallback,this.isListening=e.isListening||!0},K2.OSCClient.prototype.sendOSC=function(e,t){var n=this.oscHandler.OSCEncoder.encode(e),r=t;typeof t=="undefined"&&(r={"sendRemote":!0,"sendLocal":!0}),r.sendRemote!==!1&&this.oscHandler.proxyOK===!0&&this.oscHandler.socket.emit("osc",{"osc":n}),r.sendLocal!==!1&&this.oscHandler.sendLocalMessage.apply(this.oscHandler,[n,this.clientID])},K2.OSCHandler=function(e,t){this.localClients={},this.OSCDecoder=new K2.OSC.Decoder,this.OSCEncoder=new K2.OSC.Encoder,this.udpServers=t||null,this.proxyServer=e||null,this.proxyOK=!1,this.proxyConnected=!1;if(this.proxyServer!==null){try{this.socket=io.connect("http://"+this.proxyServer.host+":"+this.proxyServer.port)}catch(n){console.error("io.connect failed. No proxy server?");return}this.socket.on("admin",function(e){console.log("Received an admin message: ",e),this.proxyOK=!0,this.udpServers!==null&&this.socket.emit("admin",{"type":"udphosts","content":this.udpServers})}.bind(this)),this.socket.on("osc",function(e){var t=Array.prototype.slice.call(e.osc,0);console.log("received osc from the server: "+t),this.sendLocalMessage(t)}.bind(this)),this.socket.on("disconnect",function(e){console.log("socket disconnected"),this.proxyConnected=!1,this.proxyOK=!1}.bind(this)),this.socket.on("connect",function(e){console.log("socket connected"),this.proxyConnected=!0}.bind(this))}},K2.OSCHandler.prototype.registerClient=function(e){return this.localClients[e.clientID]=new K2.OSCClient(e,this),this.localClients[e.clientID]},K2.OSCHandler.prototype.unregisterClient=function(e){delete this.localClients[e]},K2.OSCHandler.prototype.sendLocalMessage=function(e,t){var n=this.OSCDecoder.decode(e);console.log("decoded OSC = "+n);for(var r in this.localClients)if(this.localClients.hasOwnProperty(r)){var i=this.localClients[r];i.clientID!==t&&i.isListening&&typeof i.oscCallback=="function"&&i.oscCallback(n)}};var fact_table=[1,1,2,6,24,120,720,5040,40320,362880,3628800,39916800,479001600,6227020800,87178291200,1307674368e3,20922789888e3,355687428096e3,6402373705728e3,0x1b02b9306890000,243290200817664e4,5109094217170944e4,0x3ceea4c2b3e0d80000,2.585201673888498e22,6.204484017332394e23,1.5511210043330986e25,4.0329146112660565e26,1.0888869450418352e28,3.0488834461171387e29,8.841761993739702e30,2.6525285981219107e32,8.222838654177922e33,2.631308369336935e35,8.683317618811886e36,2.9523279903960416e38,1.0333147966386145e40,3.7199332678990125e41,1.3763753091226346e43,5.230226174666011e44,2.0397882081197444e46,8.159152832478977e47,3.345252661316381e49,1.40500611775288e51,6.041526306337383e52,2.658271574788449e54,1.1962222086548019e56,5.502622159812089e57,2.5862324151116818e59,1.2413915592536073e61,6.082818640342675e62,3.0414093201713376e64,1.5511187532873822e66,8.065817517094388e67,4.2748832840600255e69,2.308436973392414e71,1.2696403353658276e73,7.109985878048635e74,4.0526919504877214e76,2.3505613312828785e78,1.3868311854568984e80,8.32098711274139e81,5.075802138772248e83,3.146997326038794e85,1.98260831540444e87,1.2688693218588417e89,8.247650592082472e90,5.443449390774431e92,3.647111091818868e94,2.4800355424368305e96,1.711224524281413e98,1.1978571669969892e100,8.504785885678623e101,6.1234458376886085e103,4.4701154615126844e105,3.307885441519386e107,2.48091408113954e109,1.8854947016660504e111,1.4518309202828587e113,1.1324281178206297e115,8.946182130782976e116,7.156945704626381e118,5.797126020747368e120,4.753643337012842e122,3.945523969720659e124,3.314240134565353e126,2.81710411438055e128,2.4227095383672734e130,2.107757298379528e132,1.8548264225739844e134,1.650795516090846e136,1.4857159644817615e138,1.352001527678403e140,1.2438414054641308e142,1.1567725070816416e144,1.087366156656743e146,1.032997848823906e148,9.916779348709496e149,9.619275968248212e151,9.426890448883248e153,9.332621544394415e155,9.332621544394415e157];K2.GenericUtils={},K2.GenericUtils.clone=function(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,r=e.length;n<r;++n)t[n]=K2.GenericUtils.clone(e[n]);return t}if(e instanceof Object){t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=K2.GenericUtils.clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},K2.MathUtils={},K2.MathUtils.linearRange=function(e,t,n,r,i){var s=(i-e)*(r-n)/(t-e)+n;return s},K2.MathUtils.distance=function(e,t,n,r){return Math.sqrt(Math.pow(e-n,2)+Math.pow(t-r,2))},K2.CanvasUtils={},K2.CanvasUtils.drawRotate=function(e,t){e.save(),e.translate(t.x+t.image.width/2,t.y+t.image.height/2),e.rotate(t.rot),e.translate(-(t.image.width/2)-t.x,-(t.image.height/2)-t.y),e.drawImage(t.image,t.x,t.y),e.restore()},typeof window.define=="function"&&window.define.amd?(console.log("AMD detected, setting define"),window.define("kievII",[],function(){return console.log("KievII: returning K2 object inside the define (AMD detected)"),K2})):(console.log("KievII: setting window.K2 (no AMD)"),window.kievII=window.K2=K2);